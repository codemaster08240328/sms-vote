"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const mongoose = require("mongoose");
const RoundContestantSchema = new mongoose.Schema({
    Detail: { type: mongoose.Schema.Types.ObjectId, ref: 'Contestant' },
    Enabled: Boolean,
    EaselNumber: Number,
    Votes: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Registration' }]
});
const RoundSchema = new mongoose.Schema({
    RoundNumber: Number,
    Contestants: [RoundContestantSchema],
    IsFinished: { type: Boolean, default: false }
});
const EventSchema = new mongoose.Schema({
    Name: { type: String, unique: true },
    Contestants: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Contestant' }],
    Rounds: [RoundSchema],
    PhoneNumber: String,
    Registrations: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Registration' }],
    CurrentRound: RoundSchema,
    Enabled: Boolean,
    RegistrationConfirmationMessage: String
});
EventSchema.methods.hasVoted = function (phoneNumber) {
    const thisEvent = this;
    return thisEvent.CurrentRound.Contestants.reduce((prev, cur) => prev.concat(cur.Votes.map(v => v.PhoneNumber)), [])
        .find(n => n === phoneNumber) ? true : false;
};
EventSchema.methods.edit = function EditEvent(dto) {
    const thisEvent = this;
    thisEvent.Name = dto.Name;
    thisEvent.PhoneNumber = dto.PhoneNumber;
    thisEvent.Contestants = dto.Contestants;
    thisEvent.RegistrationConfirmationMessage = dto.RegistrationConfirmationMessage;
    thisEvent.Enabled = dto.Enabled;
    const roundIds = dto.Rounds.map(r => r._id);
    thisEvent.Rounds = thisEvent.Rounds.filter(r => roundIds.contains(r.id));
    thisEvent.Rounds.forEach(r => {
        const roundDto = dto.Rounds.find(x => x._id == r.id);
        const contestantIds = roundDto.Contestants.map(c => c._id);
        r.Contestants = r.Contestants.filter(c => contestantIds.contains(c.id));
        r.Contestants.forEach(c => {
            const contestantDto = roundDto.Contestants.find(x => x._id == c.id);
            c.EaselNumber = contestantDto.EaselNumber;
            c.Enabled = contestantDto.Enabled;
        });
        const existingContestantIds = r.Contestants.map(c => c.id);
        const newContestants = roundDto.Contestants.filter(cdto => !existingContestantIds.contains(cdto._id));
        r.Contestants.addRange(newContestants);
    });
    const currentRound = thisEvent.CurrentRound;
    if (currentRound) {
        const roundDto = dto.Rounds.find(x => x._id == currentRound.id);
        const contestantIds = roundDto.Contestants.map(c => c._id);
        currentRound.Contestants = currentRound.Contestants.filter(c => contestantIds.contains(c.id));
        currentRound.Contestants.forEach(c => {
            const contestantDto = roundDto.Contestants.find(x => x._id == c.id);
            c.EaselNumber = contestantDto.EaselNumber;
            c.Enabled = contestantDto.Enabled;
        });
        const existingContestantIds = currentRound.Contestants.map(c => c.id);
        const newContestants = roundDto.Contestants.filter(cdto => !existingContestantIds.contains(cdto._id));
        currentRound.Contestants.addRange(newContestants);
    }
    const existingEventIds = thisEvent.Rounds.map(r => r.id);
    const newRounds = dto.Rounds.filter(rdto => !existingEventIds.contains(rdto._id));
    thisEvent.Rounds.addRange(newRounds);
};
const EventModel = mongoose.model('Event', EventSchema);
exports.default = EventModel;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBTyxDQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDN0UsTUFBTSxjQUFjLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUN0RyxZQUFZLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQztLQUNyRDtJQUVELE1BQU0sZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBTyxDQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDaEUsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNsRixTQUFTLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN6QyxDQUFDLENBQUM7QUFJRixNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFnQixPQUFPLEVBQUUsV0FBVyxDQUFDLENBQUM7QUFDdkUsa0JBQWUsVUFBVSxDQUFDIiwiZmlsZSI6Im1vZGVscy9FdmVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIG1vbmdvb3NlIGZyb20gJ21vbmdvb3NlJztcclxuXHJcbmltcG9ydCB7IFJlZ2lzdHJhdGlvblNjaGVtYSB9IGZyb20gJy4vUmVnaXN0cmF0aW9uJztcclxuaW1wb3J0IEV2ZW50RFRPIGZyb20gJy4uLy4uLy4uL3NoYXJlZC9FdmVudERUTyc7XHJcbmltcG9ydCBSb3VuZERUTyBmcm9tICcuLi8uLi8uLi9zaGFyZWQvUm91bmREVE8nO1xyXG5pbXBvcnQgUm91bmRDb250ZXN0YW50RFRPIGZyb20gJy4uLy4uLy4uL3NoYXJlZC9Sb3VuZENvbnRlc3RhbnREVE8nO1xyXG5pbXBvcnQgUmVnaXN0cmF0aW9uRFRPIGZyb20gJy4uLy4uLy4uL3NoYXJlZC9SZWdpc3RyYXRpb25EVE8nO1xyXG5pbXBvcnQgeyBydW5JblRoaXNDb250ZXh0IH0gZnJvbSAndm0nO1xyXG5cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnREb2N1bWVudCBleHRlbmRzIEV2ZW50RFRPLCBtb25nb29zZS5Eb2N1bWVudCB7XHJcbiAgICBoYXNWb3RlZChwaG9uZU51bWJlcjogc3RyaW5nKTogYm9vbGVhbjtcclxuICAgIGVkaXQoZHRvOiBFdmVudERUTyk6IHZvaWQ7XHJcbn1cclxuXHJcbmNvbnN0IFJvdW5kQ29udGVzdGFudFNjaGVtYTogbW9uZ29vc2UuU2NoZW1hID0gbmV3IG1vbmdvb3NlLlNjaGVtYSh7XHJcbiAgICBEZXRhaWw6IHsgdHlwZTogbW9uZ29vc2UuU2NoZW1hLlR5cGVzLk9iamVjdElkLCByZWY6ICdDb250ZXN0YW50J30sXHJcbiAgICBFbmFibGVkOiBCb29sZWFuLFxyXG4gICAgRWFzZWxOdW1iZXI6IE51bWJlcixcclxuICAgIFZvdGVzOiBbeyB0eXBlOiBtb25nb29zZS5TY2hlbWEuVHlwZXMuT2JqZWN0SWQsIHJlZjogJ1JlZ2lzdHJhdGlvbid9XVxyXG59KTtcclxuXHJcbmNvbnN0IFJvdW5kU2NoZW1hOiBtb25nb29zZS5TY2hlbWEgPSBuZXcgbW9uZ29vc2UuU2NoZW1hKHtcclxuICAgIFJvdW5kTnVtYmVyOiBOdW1iZXIsXHJcbiAgICBDb250ZXN0YW50czogW1JvdW5kQ29udGVzdGFudFNjaGVtYV0sXHJcbiAgICBJc0ZpbmlzaGVkOiB7IHR5cGU6IEJvb2xlYW4sIGRlZmF1bHQ6IGZhbHNlIH1cclxufSk7XHJcblxyXG5jb25zdCBFdmVudFNjaGVtYTogbW9uZ29vc2UuU2NoZW1hID0gbmV3IG1vbmdvb3NlLlNjaGVtYSh7XHJcbiAgICBOYW1lOiB7IHR5cGU6IFN0cmluZywgdW5pcXVlOiB0cnVlIH0sXHJcbiAgICBDb250ZXN0YW50czogW3t0eXBlOiBtb25nb29zZS5TY2hlbWEuVHlwZXMuT2JqZWN0SWQsIHJlZjogJ0NvbnRlc3RhbnQnfV0sXHJcbiAgICBSb3VuZHM6IFtSb3VuZFNjaGVtYV0sXHJcbiAgICBQaG9uZU51bWJlcjogU3RyaW5nLFxyXG4gICAgUmVnaXN0cmF0aW9uczogW3sgdHlwZTogbW9uZ29vc2UuU2NoZW1hLlR5cGVzLk9iamVjdElkLCByZWY6ICdSZWdpc3RyYXRpb24nIH1dLFxyXG4gICAgQ3VycmVudFJvdW5kOiBSb3VuZFNjaGVtYSxcclxuICAgIEVuYWJsZWQ6IEJvb2xlYW4sXHJcbiAgICBSZWdpc3RyYXRpb25Db25maXJtYXRpb25NZXNzYWdlOiBTdHJpbmdcclxufSk7XHJcblxyXG5FdmVudFNjaGVtYS5tZXRob2RzLmhhc1ZvdGVkID0gZnVuY3Rpb24ocGhvbmVOdW1iZXI6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGNvbnN0IHRoaXNFdmVudCA9ICg8RXZlbnREb2N1bWVudD50aGlzKTtcclxuICAgICAgICByZXR1cm4gdGhpc0V2ZW50LkN1cnJlbnRSb3VuZC5Db250ZXN0YW50cy5yZWR1Y2UoKHByZXY6IHN0cmluZ1tdLCBjdXI6IFJvdW5kQ29udGVzdGFudERUTykgPT4gcHJldi5jb25jYXQoY3VyLlZvdGVzLm1hcCh2ID0+IHYuUGhvbmVOdW1iZXIpKSwgW10pXHJcbiAgICAgICAgICAgIC5maW5kKG4gPT4gbiA9PT0gcGhvbmVOdW1iZXIpID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgfTtcclxuXHJcbkV2ZW50U2NoZW1hLm1ldGhvZHMuZWRpdCA9IGZ1bmN0aW9uIEVkaXRFdmVudChkdG86IEV2ZW50RFRPKTogdm9pZCB7XHJcbiAgICBjb25zdCB0aGlzRXZlbnQgPSAoPEV2ZW50RG9jdW1lbnQ+dGhpcyk7XHJcbiAgICB0aGlzRXZlbnQuTmFtZSA9IGR0by5OYW1lO1xyXG4gICAgdGhpc0V2ZW50LlBob25lTnVtYmVyID0gZHRvLlBob25lTnVtYmVyO1xyXG4gICAgdGhpc0V2ZW50LkNvbnRlc3RhbnRzID0gZHRvLkNvbnRlc3RhbnRzO1xyXG4gICAgdGhpc0V2ZW50LlJlZ2lzdHJhdGlvbkNvbmZpcm1hdGlvbk1lc3NhZ2UgPSBkdG8uUmVnaXN0cmF0aW9uQ29uZmlybWF0aW9uTWVzc2FnZTtcclxuICAgIHRoaXNFdmVudC5FbmFibGVkID0gZHRvLkVuYWJsZWQ7XHJcbiAgICBjb25zdCByb3VuZElkcyA9IGR0by5Sb3VuZHMubWFwKHIgPT4gci5faWQpO1xyXG4gICAgdGhpc0V2ZW50LlJvdW5kcyA9IHRoaXNFdmVudC5Sb3VuZHMuZmlsdGVyKHIgPT4gcm91bmRJZHMuY29udGFpbnMoKDxhbnk+cikuaWQpKTtcclxuICAgIHRoaXNFdmVudC5Sb3VuZHMuZm9yRWFjaChyID0+IHtcclxuICAgICAgICBjb25zdCByb3VuZER0byA9IGR0by5Sb3VuZHMuZmluZCh4ID0+IHguX2lkID09ICg8YW55PnIpLmlkKTtcclxuICAgICAgICBjb25zdCBjb250ZXN0YW50SWRzID0gcm91bmREdG8uQ29udGVzdGFudHMubWFwKGMgPT4gYy5faWQpO1xyXG4gICAgICAgIHIuQ29udGVzdGFudHMgPSByLkNvbnRlc3RhbnRzLmZpbHRlcihjID0+IGNvbnRlc3RhbnRJZHMuY29udGFpbnMoKDxhbnk+YykuaWQpKTtcclxuICAgICAgICByLkNvbnRlc3RhbnRzLmZvckVhY2goYyA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlc3RhbnREdG8gPSByb3VuZER0by5Db250ZXN0YW50cy5maW5kKHggPT4geC5faWQgPT0gKDxhbnk+YykuaWQpO1xyXG4gICAgICAgICAgICBjLkVhc2VsTnVtYmVyID0gY29udGVzdGFudER0by5FYXNlbE51bWJlcjtcclxuICAgICAgICAgICAgYy5FbmFibGVkID0gY29udGVzdGFudER0by5FbmFibGVkO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nQ29udGVzdGFudElkcyA9IHIuQ29udGVzdGFudHMubWFwKGMgPT4gKDxhbnk+YykuaWQpO1xyXG4gICAgICAgIGNvbnN0IG5ld0NvbnRlc3RhbnRzID0gcm91bmREdG8uQ29udGVzdGFudHMuZmlsdGVyKGNkdG8gPT4gIWV4aXN0aW5nQ29udGVzdGFudElkcy5jb250YWlucyhjZHRvLl9pZCkpO1xyXG4gICAgICAgIHIuQ29udGVzdGFudHMuYWRkUmFuZ2UobmV3Q29udGVzdGFudHMpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgY3VycmVudFJvdW5kID0gdGhpc0V2ZW50LkN1cnJlbnRSb3VuZDtcclxuICAgIGlmIChjdXJyZW50Um91bmQpIHtcclxuICAgICAgICBjb25zdCByb3VuZER0byA9IGR0by5Sb3VuZHMuZmluZCh4ID0+IHguX2lkID09ICg8YW55PmN1cnJlbnRSb3VuZCkuaWQpO1xyXG4gICAgICAgIGNvbnN0IGNvbnRlc3RhbnRJZHMgPSByb3VuZER0by5Db250ZXN0YW50cy5tYXAoYyA9PiBjLl9pZCk7XHJcbiAgICAgICAgY3VycmVudFJvdW5kLkNvbnRlc3RhbnRzID0gY3VycmVudFJvdW5kLkNvbnRlc3RhbnRzLmZpbHRlcihjID0+IGNvbnRlc3RhbnRJZHMuY29udGFpbnMoKDxhbnk+YykuaWQpKTtcclxuICAgICAgICBjdXJyZW50Um91bmQuQ29udGVzdGFudHMuZm9yRWFjaChjID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY29udGVzdGFudER0byA9IHJvdW5kRHRvLkNvbnRlc3RhbnRzLmZpbmQoeCA9PiB4Ll9pZCA9PSAoPGFueT5jKS5pZCk7XHJcbiAgICAgICAgICAgIGMuRWFzZWxOdW1iZXIgPSBjb250ZXN0YW50RHRvLkVhc2VsTnVtYmVyO1xyXG4gICAgICAgICAgICBjLkVuYWJsZWQgPSBjb250ZXN0YW50RHRvLkVuYWJsZWQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc3QgZXhpc3RpbmdDb250ZXN0YW50SWRzID0gY3VycmVudFJvdW5kLkNvbnRlc3RhbnRzLm1hcChjID0+ICg8YW55PmMpLmlkKTtcclxuICAgICAgICBjb25zdCBuZXdDb250ZXN0YW50cyA9IHJvdW5kRHRvLkNvbnRlc3RhbnRzLmZpbHRlcihjZHRvID0+ICFleGlzdGluZ0NvbnRlc3RhbnRJZHMuY29udGFpbnMoY2R0by5faWQpKTtcclxuICAgICAgICBjdXJyZW50Um91bmQuQ29udGVzdGFudHMuYWRkUmFuZ2UobmV3Q29udGVzdGFudHMpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGV4aXN0aW5nRXZlbnRJZHMgPSB0aGlzRXZlbnQuUm91bmRzLm1hcChyID0+ICg8YW55PnIpLmlkKTtcclxuICAgIGNvbnN0IG5ld1JvdW5kcyA9IGR0by5Sb3VuZHMuZmlsdGVyKHJkdG8gPT4gIWV4aXN0aW5nRXZlbnRJZHMuY29udGFpbnMocmR0by5faWQpKTtcclxuICAgIHRoaXNFdmVudC5Sb3VuZHMuYWRkUmFuZ2UobmV3Um91bmRzKTtcclxufTtcclxuXHJcblxyXG5cclxuY29uc3QgRXZlbnRNb2RlbCA9IG1vbmdvb3NlLm1vZGVsPEV2ZW50RG9jdW1lbnQ+KCdFdmVudCcsIEV2ZW50U2NoZW1hKTtcclxuZXhwb3J0IGRlZmF1bHQgRXZlbnRNb2RlbDsiXX0=

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const mongoose = require("mongoose");
const RoundContestantSchema = new mongoose.Schema({
    Detail: { type: mongoose.Schema.Types.ObjectId, ref: 'Contestant' },
    Enabled: Boolean,
    EaselNumber: Number,
    Votes: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Registration' }]
});
const RoundSchema = new mongoose.Schema({
    RoundNumber: Number,
    Contestants: [RoundContestantSchema],
    IsFinished: { type: Boolean, default: false }
});
const EventSchema = new mongoose.Schema({
    Name: { type: String, unique: true },
    Contestants: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Contestant' }],
    Rounds: [RoundSchema],
    PhoneNumber: String,
    Registrations: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Registration' }],
    CurrentRound: RoundSchema,
    Enabled: Boolean,
    RegistrationConfirmationMessage: String
});
EventSchema.methods.hasVoted = function (phoneNumber) {
    const thisEvent = this;
    return thisEvent.CurrentRound.Contestants.reduce((prev, cur) => prev.concat(cur.Votes.map(v => v.PhoneNumber)), [])
        .find(n => n === phoneNumber) ? true : false;
};
EventSchema.methods.edit = function (dto) {
    const thisEvent = this;
    thisEvent.Name = dto.Name;
    thisEvent.PhoneNumber = dto.PhoneNumber;
    thisEvent.Contestants = dto.Contestants;
    thisEvent.RegistrationConfirmationMessage = dto.RegistrationConfirmationMessage;
    thisEvent.Enabled = dto.Enabled;
    const roundIds = dto.Rounds.map(r => r._id);
    thisEvent.Rounds = thisEvent.Rounds.filter(r => roundIds.contains(r.id));
    thisEvent.Rounds.forEach(r => {
        const roundDto = dto.Rounds.find(x => x._id == r.id);
        const contestantIds = roundDto.Contestants.map(c => c._id);
        r.Contestants = r.Contestants.filter(c => contestantIds.contains(c.id));
        r.Contestants.forEach(c => {
            const contestantDto = roundDto.Contestants.find(x => x._id == c.id);
            c.EaselNumber = contestantDto.EaselNumber;
            c.Enabled = contestantDto.Enabled;
        });
    });
    const newRounds = dto.Rounds.filter(rdto => !thisEvent.Rounds.map(r => r.id).contains(rdto._id));
    thisEvent.Rounds.addRange(newRounds);
};
const EventModel = mongoose.model('Event', EventSchema);
exports.default = EventModel;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZGVscy9FdmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFxQztBQWVyQyxNQUFNLHFCQUFxQixHQUFvQixJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUM7SUFDL0QsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFDO0lBQ2xFLE9BQU8sRUFBRSxPQUFPO0lBQ2hCLFdBQVcsRUFBRSxNQUFNO0lBQ25CLEtBQUssRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsY0FBYyxFQUFDLENBQUM7Q0FDeEUsQ0FBQyxDQUFDO0FBRUgsTUFBTSxXQUFXLEdBQW9CLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQztJQUNyRCxXQUFXLEVBQUUsTUFBTTtJQUNuQixXQUFXLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQztJQUNwQyxVQUFVLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUU7Q0FDaEQsQ0FBQyxDQUFDO0FBRUgsTUFBTSxXQUFXLEdBQW9CLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQztJQUNyRCxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7SUFDcEMsV0FBVyxFQUFFLENBQUMsRUFBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxZQUFZLEVBQUMsQ0FBQztJQUN4RSxNQUFNLEVBQUUsQ0FBQyxXQUFXLENBQUM7SUFDckIsV0FBVyxFQUFFLE1BQU07SUFDbkIsYUFBYSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxjQUFjLEVBQUUsQ0FBQztJQUM5RSxZQUFZLEVBQUUsV0FBVztJQUN6QixPQUFPLEVBQUUsT0FBTztJQUNoQiwrQkFBK0IsRUFBRSxNQUFNO0NBQzFDLENBQUMsQ0FBQztBQUVILFdBQVcsQ0FBQyxPQUFPLENBQUMsUUFBUSxHQUFHLFVBQVMsV0FBbUI7SUFDbkQsTUFBTSxTQUFTLEdBQW1CLElBQUssQ0FBQztJQUN4QyxPQUFPLFNBQVMsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQWMsRUFBRSxHQUF1QixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDO1NBQzVJLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDckQsQ0FBQyxDQUFDO0FBRU4sV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsVUFBUyxHQUFhO0lBQzdDLE1BQU0sU0FBUyxHQUFtQixJQUFLLENBQUM7SUFDeEMsU0FBUyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO0lBQzFCLFNBQVMsQ0FBQyxXQUFXLEdBQUcsR0FBRyxDQUFDLFdBQVcsQ0FBQztJQUN4QyxTQUFTLENBQUMsV0FBVyxHQUFHLEdBQUcsQ0FBQyxXQUFXLENBQUM7SUFDeEMsU0FBUyxDQUFDLCtCQUErQixHQUFHLEdBQUcsQ0FBQywrQkFBK0IsQ0FBQztJQUNoRixTQUFTLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUM7SUFDaEMsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDNUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQU8sQ0FBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEYsU0FBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDekIsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFVLENBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM1RCxNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzRCxDQUFDLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBTyxDQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMvRSxDQUFDLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUN0QixNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQVUsQ0FBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzNFLENBQUMsQ0FBQyxXQUFXLEdBQUcsYUFBYSxDQUFDLFdBQVcsQ0FBQztZQUMxQyxDQUFDLENBQUMsT0FBTyxHQUFHLGFBQWEsQ0FBQyxPQUFPLENBQUM7UUFDdEMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztJQUNILE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFPLENBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDeEcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDekMsQ0FBQyxDQUFDO0FBRUYsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBZ0IsT0FBTyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQ3ZFLGtCQUFlLFVBQVUsQ0FBQyIsImZpbGUiOiJtb2RlbHMvRXZlbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBtb25nb29zZSBmcm9tICdtb25nb29zZSc7XHJcblxyXG5pbXBvcnQgeyBSZWdpc3RyYXRpb25TY2hlbWEgfSBmcm9tICcuL1JlZ2lzdHJhdGlvbic7XHJcbmltcG9ydCBFdmVudERUTyBmcm9tICcuLi8uLi8uLi9zaGFyZWQvRXZlbnREVE8nO1xyXG5pbXBvcnQgUm91bmREVE8gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL1JvdW5kRFRPJztcclxuaW1wb3J0IFJvdW5kQ29udGVzdGFudERUTyBmcm9tICcuLi8uLi8uLi9zaGFyZWQvUm91bmRDb250ZXN0YW50RFRPJztcclxuaW1wb3J0IFJlZ2lzdHJhdGlvbkRUTyBmcm9tICcuLi8uLi8uLi9zaGFyZWQvUmVnaXN0cmF0aW9uRFRPJztcclxuaW1wb3J0IHsgcnVuSW5UaGlzQ29udGV4dCB9IGZyb20gJ3ZtJztcclxuXHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50RG9jdW1lbnQgZXh0ZW5kcyBFdmVudERUTywgbW9uZ29vc2UuRG9jdW1lbnQge1xyXG4gICAgaGFzVm90ZWQocGhvbmVOdW1iZXI6IHN0cmluZyk6IGJvb2xlYW47XHJcbiAgICBlZGl0KGR0bzogRXZlbnREVE8pOiB2b2lkO1xyXG59XHJcblxyXG5jb25zdCBSb3VuZENvbnRlc3RhbnRTY2hlbWE6IG1vbmdvb3NlLlNjaGVtYSA9IG5ldyBtb25nb29zZS5TY2hlbWEoe1xyXG4gICAgRGV0YWlsOiB7IHR5cGU6IG1vbmdvb3NlLlNjaGVtYS5UeXBlcy5PYmplY3RJZCwgcmVmOiAnQ29udGVzdGFudCd9LFxyXG4gICAgRW5hYmxlZDogQm9vbGVhbixcclxuICAgIEVhc2VsTnVtYmVyOiBOdW1iZXIsXHJcbiAgICBWb3RlczogW3sgdHlwZTogbW9uZ29vc2UuU2NoZW1hLlR5cGVzLk9iamVjdElkLCByZWY6ICdSZWdpc3RyYXRpb24nfV1cclxufSk7XHJcblxyXG5jb25zdCBSb3VuZFNjaGVtYTogbW9uZ29vc2UuU2NoZW1hID0gbmV3IG1vbmdvb3NlLlNjaGVtYSh7XHJcbiAgICBSb3VuZE51bWJlcjogTnVtYmVyLFxyXG4gICAgQ29udGVzdGFudHM6IFtSb3VuZENvbnRlc3RhbnRTY2hlbWFdLFxyXG4gICAgSXNGaW5pc2hlZDogeyB0eXBlOiBCb29sZWFuLCBkZWZhdWx0OiBmYWxzZSB9XHJcbn0pO1xyXG5cclxuY29uc3QgRXZlbnRTY2hlbWE6IG1vbmdvb3NlLlNjaGVtYSA9IG5ldyBtb25nb29zZS5TY2hlbWEoe1xyXG4gICAgTmFtZTogeyB0eXBlOiBTdHJpbmcsIHVuaXF1ZTogdHJ1ZSB9LFxyXG4gICAgQ29udGVzdGFudHM6IFt7dHlwZTogbW9uZ29vc2UuU2NoZW1hLlR5cGVzLk9iamVjdElkLCByZWY6ICdDb250ZXN0YW50J31dLFxyXG4gICAgUm91bmRzOiBbUm91bmRTY2hlbWFdLFxyXG4gICAgUGhvbmVOdW1iZXI6IFN0cmluZyxcclxuICAgIFJlZ2lzdHJhdGlvbnM6IFt7IHR5cGU6IG1vbmdvb3NlLlNjaGVtYS5UeXBlcy5PYmplY3RJZCwgcmVmOiAnUmVnaXN0cmF0aW9uJyB9XSxcclxuICAgIEN1cnJlbnRSb3VuZDogUm91bmRTY2hlbWEsXHJcbiAgICBFbmFibGVkOiBCb29sZWFuLFxyXG4gICAgUmVnaXN0cmF0aW9uQ29uZmlybWF0aW9uTWVzc2FnZTogU3RyaW5nXHJcbn0pO1xyXG5cclxuRXZlbnRTY2hlbWEubWV0aG9kcy5oYXNWb3RlZCA9IGZ1bmN0aW9uKHBob25lTnVtYmVyOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICBjb25zdCB0aGlzRXZlbnQgPSAoPEV2ZW50RG9jdW1lbnQ+dGhpcyk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXNFdmVudC5DdXJyZW50Um91bmQuQ29udGVzdGFudHMucmVkdWNlKChwcmV2OiBzdHJpbmdbXSwgY3VyOiBSb3VuZENvbnRlc3RhbnREVE8pID0+IHByZXYuY29uY2F0KGN1ci5Wb3Rlcy5tYXAodiA9PiB2LlBob25lTnVtYmVyKSksIFtdKVxyXG4gICAgICAgICAgICAuZmluZChuID0+IG4gPT09IHBob25lTnVtYmVyKSA/IHRydWUgOiBmYWxzZTtcclxuICAgIH07XHJcblxyXG5FdmVudFNjaGVtYS5tZXRob2RzLmVkaXQgPSBmdW5jdGlvbihkdG86IEV2ZW50RFRPKTogdm9pZCB7XHJcbiAgICBjb25zdCB0aGlzRXZlbnQgPSAoPEV2ZW50RG9jdW1lbnQ+dGhpcyk7XHJcbiAgICB0aGlzRXZlbnQuTmFtZSA9IGR0by5OYW1lO1xyXG4gICAgdGhpc0V2ZW50LlBob25lTnVtYmVyID0gZHRvLlBob25lTnVtYmVyO1xyXG4gICAgdGhpc0V2ZW50LkNvbnRlc3RhbnRzID0gZHRvLkNvbnRlc3RhbnRzO1xyXG4gICAgdGhpc0V2ZW50LlJlZ2lzdHJhdGlvbkNvbmZpcm1hdGlvbk1lc3NhZ2UgPSBkdG8uUmVnaXN0cmF0aW9uQ29uZmlybWF0aW9uTWVzc2FnZTtcclxuICAgIHRoaXNFdmVudC5FbmFibGVkID0gZHRvLkVuYWJsZWQ7XHJcbiAgICBjb25zdCByb3VuZElkcyA9IGR0by5Sb3VuZHMubWFwKHIgPT4gci5faWQpO1xyXG4gICAgdGhpc0V2ZW50LlJvdW5kcyA9IHRoaXNFdmVudC5Sb3VuZHMuZmlsdGVyKHIgPT4gcm91bmRJZHMuY29udGFpbnMoKDxhbnk+cikuaWQpKTtcclxuICAgIHRoaXNFdmVudC5Sb3VuZHMuZm9yRWFjaChyID0+IHtcclxuICAgICAgICBjb25zdCByb3VuZER0byA9IGR0by5Sb3VuZHMuZmluZCh4ID0+IHguX2lkID09ICg8YW55PnIpLmlkKTtcclxuICAgICAgICBjb25zdCBjb250ZXN0YW50SWRzID0gcm91bmREdG8uQ29udGVzdGFudHMubWFwKGMgPT4gYy5faWQpO1xyXG4gICAgICAgIHIuQ29udGVzdGFudHMgPSByLkNvbnRlc3RhbnRzLmZpbHRlcihjID0+IGNvbnRlc3RhbnRJZHMuY29udGFpbnMoKDxhbnk+YykuaWQpKTtcclxuICAgICAgICByLkNvbnRlc3RhbnRzLmZvckVhY2goYyA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlc3RhbnREdG8gPSByb3VuZER0by5Db250ZXN0YW50cy5maW5kKHggPT4geC5faWQgPT0gKDxhbnk+YykuaWQpO1xyXG4gICAgICAgICAgICBjLkVhc2VsTnVtYmVyID0gY29udGVzdGFudER0by5FYXNlbE51bWJlcjtcclxuICAgICAgICAgICAgYy5FbmFibGVkID0gY29udGVzdGFudER0by5FbmFibGVkO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICBjb25zdCBuZXdSb3VuZHMgPSBkdG8uUm91bmRzLmZpbHRlcihyZHRvID0+ICF0aGlzRXZlbnQuUm91bmRzLm1hcChyID0+ICg8YW55PnIpLmlkKS5jb250YWlucyhyZHRvLl9pZCkpO1xyXG4gICAgdGhpc0V2ZW50LlJvdW5kcy5hZGRSYW5nZShuZXdSb3VuZHMpO1xyXG59O1xyXG5cclxuY29uc3QgRXZlbnRNb2RlbCA9IG1vbmdvb3NlLm1vZGVsPEV2ZW50RG9jdW1lbnQ+KCdFdmVudCcsIEV2ZW50U2NoZW1hKTtcclxuZXhwb3J0IGRlZmF1bHQgRXZlbnRNb2RlbDsiXX0=

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const mongoose = require("mongoose");
const RoundContestantSchema = new mongoose.Schema({
    Detail: { type: mongoose.Schema.Types.ObjectId, ref: 'Contestant' },
    Enabled: Boolean,
    EaselNumber: Number,
    Votes: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Registration' }]
});
const RoundSchema = new mongoose.Schema({
    RoundNumber: Number,
    Contestants: [RoundContestantSchema],
    IsFinished: { type: Boolean, default: false }
});
const EventSchema = new mongoose.Schema({
    Name: { type: String, unique: true },
    Contestants: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Contestant' }],
    Rounds: [RoundSchema],
    PhoneNumber: String,
    Registrations: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Registration' }],
    CurrentRound: RoundSchema,
    Enabled: Boolean,
    RegistrationConfirmationMessage: String
});
EventSchema.methods.hasVoted = function (phoneNumber) {
    const thisEvent = this;
    return thisEvent.CurrentRound.Contestants.reduce((prev, cur) => prev.concat(cur.Votes.map(v => v.PhoneNumber)), [])
        .find(n => n === phoneNumber) ? true : false;
};
EventSchema.methods.edit = function (dto) {
    const thisEvent = this;
    thisEvent.Name = dto.Name;
    thisEvent.PhoneNumber = dto.PhoneNumber.trim();
    thisEvent.Contestants = dto.Contestants;
    thisEvent.RegistrationConfirmationMessage = dto.RegistrationConfirmationMessage;
    thisEvent.Enabled = dto.Enabled;
    const roundIds = dto.Rounds.map(r => r._id);
    thisEvent.Rounds = thisEvent.Rounds.filter(r => roundIds.contains(r.id));
    thisEvent.Rounds.forEach(r => {
        const roundDto = dto.Rounds.find(x => x._id == r.id);
        const contestantIds = roundDto.Contestants.map(c => c._id);
        r.Contestants = r.Contestants.filter(c => contestantIds.contains(c.id));
        r.Contestants.forEach(c => {
            const contestantDto = roundDto.Contestants.find(x => x._id == c.id);
            c.EaselNumber = contestantDto.EaselNumber;
            c.Enabled = contestantDto.Enabled;
        });
        const existingContestantIds = r.Contestants.map(c => c.id);
        const newContestants = roundDto.Contestants.filter(cdto => !existingContestantIds.contains(cdto._id));
        r.Contestants.addRange(newContestants);
    });
    const currentRound = thisEvent.CurrentRound;
    if (currentRound) {
        const roundDto = dto.Rounds.find(x => x._id == currentRound.id);
        const contestantIds = roundDto.Contestants.map(c => c._id);
        currentRound.Contestants = currentRound.Contestants.filter(c => contestantIds.contains(c.id));
        currentRound.Contestants.forEach(c => {
            const contestantDto = roundDto.Contestants.find(x => x._id == c.id);
            c.EaselNumber = contestantDto.EaselNumber;
            c.Enabled = contestantDto.Enabled;
        });
        const existingContestantIds = currentRound.Contestants.map(c => c.id);
        const newContestants = roundDto.Contestants.filter(cdto => !existingContestantIds.contains(cdto._id));
        currentRound.Contestants.addRange(newContestants);
    }
    const existingEventIds = thisEvent.Rounds.map(r => r.id);
    const newRounds = dto.Rounds.filter(rdto => !existingEventIds.contains(rdto._id));
    thisEvent.Rounds.addRange(newRounds);
};
const EventModel = mongoose.model('Event', EventSchema);
exports.default = EventModel;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFHLFlBQVksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQU8sQ0FBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzdFLE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDdEcsWUFBWSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUM7S0FDckQ7SUFFRCxNQUFNLGdCQUFnQixHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQU8sQ0FBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2hFLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDbEYsU0FBUyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDekMsQ0FBQyxDQUFDO0FBSUYsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBZ0IsT0FBTyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQ3ZFLGtCQUFlLFVBQVUsQ0FBQyIsImZpbGUiOiJtb2RlbHMvRXZlbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBtb25nb29zZSBmcm9tICdtb25nb29zZSc7XG5cbmltcG9ydCB7IFJlZ2lzdHJhdGlvblNjaGVtYSB9IGZyb20gJy4vUmVnaXN0cmF0aW9uJztcbmltcG9ydCBFdmVudERUTyBmcm9tICcuLi8uLi8uLi9zaGFyZWQvRXZlbnREVE8nO1xuaW1wb3J0IFJvdW5kRFRPIGZyb20gJy4uLy4uLy4uL3NoYXJlZC9Sb3VuZERUTyc7XG5pbXBvcnQgUm91bmRDb250ZXN0YW50RFRPIGZyb20gJy4uLy4uLy4uL3NoYXJlZC9Sb3VuZENvbnRlc3RhbnREVE8nO1xuaW1wb3J0IFJlZ2lzdHJhdGlvbkRUTyBmcm9tICcuLi8uLi8uLi9zaGFyZWQvUmVnaXN0cmF0aW9uRFRPJztcbmltcG9ydCB7IHJ1bkluVGhpc0NvbnRleHQgfSBmcm9tICd2bSc7XG5cblxuZXhwb3J0IGludGVyZmFjZSBFdmVudERvY3VtZW50IGV4dGVuZHMgRXZlbnREVE8sIG1vbmdvb3NlLkRvY3VtZW50IHtcbiAgICBoYXNWb3RlZChwaG9uZU51bWJlcjogc3RyaW5nKTogYm9vbGVhbjtcbiAgICBlZGl0KGR0bzogRXZlbnREVE8pOiB2b2lkO1xufVxuXG5jb25zdCBSb3VuZENvbnRlc3RhbnRTY2hlbWE6IG1vbmdvb3NlLlNjaGVtYSA9IG5ldyBtb25nb29zZS5TY2hlbWEoe1xuICAgIERldGFpbDogeyB0eXBlOiBtb25nb29zZS5TY2hlbWEuVHlwZXMuT2JqZWN0SWQsIHJlZjogJ0NvbnRlc3RhbnQnfSxcbiAgICBFbmFibGVkOiBCb29sZWFuLFxuICAgIEVhc2VsTnVtYmVyOiBOdW1iZXIsXG4gICAgVm90ZXM6IFt7IHR5cGU6IG1vbmdvb3NlLlNjaGVtYS5UeXBlcy5PYmplY3RJZCwgcmVmOiAnUmVnaXN0cmF0aW9uJ31dXG59KTtcblxuY29uc3QgUm91bmRTY2hlbWE6IG1vbmdvb3NlLlNjaGVtYSA9IG5ldyBtb25nb29zZS5TY2hlbWEoe1xuICAgIFJvdW5kTnVtYmVyOiBOdW1iZXIsXG4gICAgQ29udGVzdGFudHM6IFtSb3VuZENvbnRlc3RhbnRTY2hlbWFdLFxuICAgIElzRmluaXNoZWQ6IHsgdHlwZTogQm9vbGVhbiwgZGVmYXVsdDogZmFsc2UgfVxufSk7XG5cbmNvbnN0IEV2ZW50U2NoZW1hOiBtb25nb29zZS5TY2hlbWEgPSBuZXcgbW9uZ29vc2UuU2NoZW1hKHtcbiAgICBOYW1lOiB7IHR5cGU6IFN0cmluZywgdW5pcXVlOiB0cnVlIH0sXG4gICAgQ29udGVzdGFudHM6IFt7dHlwZTogbW9uZ29vc2UuU2NoZW1hLlR5cGVzLk9iamVjdElkLCByZWY6ICdDb250ZXN0YW50J31dLFxuICAgIFJvdW5kczogW1JvdW5kU2NoZW1hXSxcbiAgICBQaG9uZU51bWJlcjogU3RyaW5nLFxuICAgIFJlZ2lzdHJhdGlvbnM6IFt7IHR5cGU6IG1vbmdvb3NlLlNjaGVtYS5UeXBlcy5PYmplY3RJZCwgcmVmOiAnUmVnaXN0cmF0aW9uJyB9XSxcbiAgICBDdXJyZW50Um91bmQ6IFJvdW5kU2NoZW1hLFxuICAgIEVuYWJsZWQ6IEJvb2xlYW4sXG4gICAgUmVnaXN0cmF0aW9uQ29uZmlybWF0aW9uTWVzc2FnZTogU3RyaW5nXG59KTtcblxuRXZlbnRTY2hlbWEubWV0aG9kcy5oYXNWb3RlZCA9IGZ1bmN0aW9uKHBob25lTnVtYmVyOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgdGhpc0V2ZW50ID0gKDxFdmVudERvY3VtZW50PnRoaXMpO1xuICAgICAgICByZXR1cm4gdGhpc0V2ZW50LkN1cnJlbnRSb3VuZC5Db250ZXN0YW50cy5yZWR1Y2UoKHByZXY6IHN0cmluZ1tdLCBjdXI6IFJvdW5kQ29udGVzdGFudERUTykgPT4gcHJldi5jb25jYXQoY3VyLlZvdGVzLm1hcCh2ID0+IHYuUGhvbmVOdW1iZXIpKSwgW10pXG4gICAgICAgICAgICAuZmluZChuID0+IG4gPT09IHBob25lTnVtYmVyKSA/IHRydWUgOiBmYWxzZTtcbiAgICB9O1xuXG5FdmVudFNjaGVtYS5tZXRob2RzLmVkaXQgPSBmdW5jdGlvbihkdG86IEV2ZW50RFRPKTogdm9pZCB7XG4gICAgY29uc3QgdGhpc0V2ZW50ID0gKDxFdmVudERvY3VtZW50PnRoaXMpO1xuICAgIHRoaXNFdmVudC5OYW1lID0gZHRvLk5hbWU7XG4gICAgdGhpc0V2ZW50LlBob25lTnVtYmVyID0gZHRvLlBob25lTnVtYmVyLnRyaW0oKTtcbiAgICB0aGlzRXZlbnQuQ29udGVzdGFudHMgPSBkdG8uQ29udGVzdGFudHM7XG4gICAgdGhpc0V2ZW50LlJlZ2lzdHJhdGlvbkNvbmZpcm1hdGlvbk1lc3NhZ2UgPSBkdG8uUmVnaXN0cmF0aW9uQ29uZmlybWF0aW9uTWVzc2FnZTtcbiAgICB0aGlzRXZlbnQuRW5hYmxlZCA9IGR0by5FbmFibGVkO1xuICAgIGNvbnN0IHJvdW5kSWRzID0gZHRvLlJvdW5kcy5tYXAociA9PiByLl9pZCk7XG4gICAgdGhpc0V2ZW50LlJvdW5kcyA9IHRoaXNFdmVudC5Sb3VuZHMuZmlsdGVyKHIgPT4gcm91bmRJZHMuY29udGFpbnMoKDxhbnk+cikuaWQpKTtcbiAgICB0aGlzRXZlbnQuUm91bmRzLmZvckVhY2gociA9PiB7XG4gICAgICAgIGNvbnN0IHJvdW5kRHRvID0gZHRvLlJvdW5kcy5maW5kKHggPT4geC5faWQgPT0gKDxhbnk+cikuaWQpO1xuICAgICAgICBjb25zdCBjb250ZXN0YW50SWRzID0gcm91bmREdG8uQ29udGVzdGFudHMubWFwKGMgPT4gYy5faWQpO1xuICAgICAgICByLkNvbnRlc3RhbnRzID0gci5Db250ZXN0YW50cy5maWx0ZXIoYyA9PiBjb250ZXN0YW50SWRzLmNvbnRhaW5zKCg8YW55PmMpLmlkKSk7XG4gICAgICAgIHIuQ29udGVzdGFudHMuZm9yRWFjaChjID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlc3RhbnREdG8gPSByb3VuZER0by5Db250ZXN0YW50cy5maW5kKHggPT4geC5faWQgPT0gKDxhbnk+YykuaWQpO1xuICAgICAgICAgICAgYy5FYXNlbE51bWJlciA9IGNvbnRlc3RhbnREdG8uRWFzZWxOdW1iZXI7XG4gICAgICAgICAgICBjLkVuYWJsZWQgPSBjb250ZXN0YW50RHRvLkVuYWJsZWQ7XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBleGlzdGluZ0NvbnRlc3RhbnRJZHMgPSByLkNvbnRlc3RhbnRzLm1hcChjID0+ICg8YW55PmMpLmlkKTtcbiAgICAgICAgY29uc3QgbmV3Q29udGVzdGFudHMgPSByb3VuZER0by5Db250ZXN0YW50cy5maWx0ZXIoY2R0byA9PiAhZXhpc3RpbmdDb250ZXN0YW50SWRzLmNvbnRhaW5zKGNkdG8uX2lkKSk7XG4gICAgICAgIHIuQ29udGVzdGFudHMuYWRkUmFuZ2UobmV3Q29udGVzdGFudHMpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgY3VycmVudFJvdW5kID0gdGhpc0V2ZW50LkN1cnJlbnRSb3VuZDtcbiAgICBpZiAoY3VycmVudFJvdW5kKSB7XG4gICAgICAgIGNvbnN0IHJvdW5kRHRvID0gZHRvLlJvdW5kcy5maW5kKHggPT4geC5faWQgPT0gKDxhbnk+Y3VycmVudFJvdW5kKS5pZCk7XG4gICAgICAgIGNvbnN0IGNvbnRlc3RhbnRJZHMgPSByb3VuZER0by5Db250ZXN0YW50cy5tYXAoYyA9PiBjLl9pZCk7XG4gICAgICAgIGN1cnJlbnRSb3VuZC5Db250ZXN0YW50cyA9IGN1cnJlbnRSb3VuZC5Db250ZXN0YW50cy5maWx0ZXIoYyA9PiBjb250ZXN0YW50SWRzLmNvbnRhaW5zKCg8YW55PmMpLmlkKSk7XG4gICAgICAgIGN1cnJlbnRSb3VuZC5Db250ZXN0YW50cy5mb3JFYWNoKGMgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29udGVzdGFudER0byA9IHJvdW5kRHRvLkNvbnRlc3RhbnRzLmZpbmQoeCA9PiB4Ll9pZCA9PSAoPGFueT5jKS5pZCk7XG4gICAgICAgICAgICBjLkVhc2VsTnVtYmVyID0gY29udGVzdGFudER0by5FYXNlbE51bWJlcjtcbiAgICAgICAgICAgIGMuRW5hYmxlZCA9IGNvbnRlc3RhbnREdG8uRW5hYmxlZDtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGV4aXN0aW5nQ29udGVzdGFudElkcyA9IGN1cnJlbnRSb3VuZC5Db250ZXN0YW50cy5tYXAoYyA9PiAoPGFueT5jKS5pZCk7XG4gICAgICAgIGNvbnN0IG5ld0NvbnRlc3RhbnRzID0gcm91bmREdG8uQ29udGVzdGFudHMuZmlsdGVyKGNkdG8gPT4gIWV4aXN0aW5nQ29udGVzdGFudElkcy5jb250YWlucyhjZHRvLl9pZCkpO1xuICAgICAgICBjdXJyZW50Um91bmQuQ29udGVzdGFudHMuYWRkUmFuZ2UobmV3Q29udGVzdGFudHMpO1xuICAgIH1cblxuICAgIGNvbnN0IGV4aXN0aW5nRXZlbnRJZHMgPSB0aGlzRXZlbnQuUm91bmRzLm1hcChyID0+ICg8YW55PnIpLmlkKTtcbiAgICBjb25zdCBuZXdSb3VuZHMgPSBkdG8uUm91bmRzLmZpbHRlcihyZHRvID0+ICFleGlzdGluZ0V2ZW50SWRzLmNvbnRhaW5zKHJkdG8uX2lkKSk7XG4gICAgdGhpc0V2ZW50LlJvdW5kcy5hZGRSYW5nZShuZXdSb3VuZHMpO1xufTtcblxuXG5cbmNvbnN0IEV2ZW50TW9kZWwgPSBtb25nb29zZS5tb2RlbDxFdmVudERvY3VtZW50PignRXZlbnQnLCBFdmVudFNjaGVtYSk7XG5leHBvcnQgZGVmYXVsdCBFdmVudE1vZGVsOyJdfQ==

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Module dependencies.
 */
const express = require("express");
const compression = require("compression"); // compresses requests
const session = require("express-session");
const bodyParser = require("body-parser");
const logger = require("morgan");
const errorHandler = require("errorhandler");
const lusca = require("lusca");
const dotenv = require("dotenv");
const mongo = require("connect-mongo");
const flash = require("express-flash");
const path = require("path");
const mongoose = require("mongoose");
const passport = require("passport");
const socketio = require("socket.io");
const http = require("http");
const expressValidator = require("express-validator");
require('./common/ArrayExtensions');
require('./common/StringExtensions');
const MongoStore = mongo(session);
/**
 * Load environment variables from .env file, where API keys and passwords are configured.
 */
dotenv.config({ path: path.join(__dirname, '.env') });
/**
 * Controllers (route handlers).
 */
const homeController = require("./controllers/home");
const userController = require("./controllers/user");
const contactController = require("./controllers/contact");
const registrationController = require("./controllers/register");
const eventController = require("./controllers/event");
const resultsController = require("./controllers/results");
/**
 * API keys and Passport configuration.
 */
const passportConfig = require("./config/passport");
/**
 * Create Express server.
 */
const app = express();
const httpServer = http.createServer(app);
const io = socketio(httpServer);
io.on('connection', (socket) => {
    console.log('a user connected');
});
/**
 * Connect to MongoDB.
 */
// mongoose.Promise = global.Promise;
mongoose.connect(process.env.MONGODB_URI || process.env.MONGOLAB_URI);
mongoose.connection.on('error', () => {
    console.log('MongoDB connection error. Please make sure MongoDB is running.');
    process.exit();
});
mongoose.Promise = global.Promise;
/**
 * Express configuration.
 */
app.set('port', process.env.PORT || 3000);
app.set('views', path.join(__dirname, './views'));
app.set('view engine', 'pug');
app.use(compression());
app.use(logger('dev'));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(expressValidator());
app.use(session({
    resave: true,
    saveUninitialized: true,
    secret: process.env.SESSION_SECRET,
    store: new MongoStore({
        url: process.env.MONGODB_URI || process.env.MONGOLAB_URI,
        autoReconnect: true
    })
}));
app.use(passport.initialize());
app.use(passport.session());
app.use(flash());
app.use(lusca.xframe('SAMEORIGIN'));
app.use(lusca.xssProtection(true));
app.use((req, res, next) => {
    res.locals.user = req.user;
    next();
});
app.use((req, res, next) => {
    // After successful login, redirect back to the intended page
    if (!req.user &&
        req.path !== '/login' &&
        req.path !== '/signup' &&
        !req.path.match(/^\/auth/) &&
        !req.path.match(/\./)) {
        req.session.returnTo = req.path;
    }
    else if (req.user &&
        req.path == '/account') {
        req.session.returnTo = req.path;
    }
    next();
});
app.use(express.static(path.join(__dirname, 'public'), { maxAge: 31557600000 }));
io.on('connection', (socket) => {
    console.log('a user connected');
});
/**
 * Boilerplate app routes.
 */
app.get('/login', userController.getLogin);
app.post('/login', userController.postLogin);
app.get('/logout', userController.logout);
app.get('/forgot', userController.getForgot);
app.post('/forgot', userController.postForgot);
app.get('/reset/:token', userController.getReset);
app.post('/reset/:token', userController.postReset);
app.get('/signup', userController.getSignup);
app.post('/signup', userController.postSignup);
app.get('/contact', contactController.getContact);
app.post('/contact', contactController.postContact);
app.get('/account', passportConfig.isAuthenticated, userController.getAccount);
app.get('/account/unlink/:provider', passportConfig.isAuthenticated, userController.getOauthUnlink);
app.post('/account/profile', passportConfig.isAuthenticated, userController.postUpdateProfile);
app.post('/account/password', passportConfig.isAuthenticated, userController.postUpdatePassword);
app.post('/account/delete', passportConfig.isAuthenticated, userController.postDeleteAccount);
/**
 * Primary app routes.
 */
app.get('/', homeController.index);
app.get('/event/:eventId/results', resultsController.index);
app.get('/event/:eventId/register', passportConfig.isAuthenticated, registrationController.index);
app.get('/event/:eventId/announce', passportConfig.isAuthenticated, eventController.getAnnounce);
app.post('/event/:eventId/announce', passportConfig.isAuthenticated, eventController.announce);
/**
 * Api routes.
 */
app.get('/api/events', passportConfig.isAuthenticated, eventController.getEvents);
app.get('/api/event/:eventId', eventController.getEvent);
app.post('/api/event/', passportConfig.isAuthenticated, eventController.saveEvent);
app.delete('/api/event/:eventId', passportConfig.isAuthenticated, eventController.deleteEvent);
app.post('/api/event/:eventId/incrementround', passportConfig.isAuthenticated, eventController.incrementRound);
app.post('/api/vote/sms', eventController.voteSMS);
app.get('/api/event/:eventId/registrations', passportConfig.isAuthenticated, registrationController.getRegistrations);
app.put('/api/event/:eventId/register', passportConfig.isAuthenticated, registrationController.registerVoter);
/**
 * Error Handler. Provides full stack - remove for production
 */
app.use(errorHandler());
/**
 * Start Express server.
 */
app.listen(app.get('port'), () => {
    console.log(('  App is running at http://localhost:%d in %s mode'), app.get('port'), app.get('env'));
    console.log('  Press CTRL-C to stop\n');
});
module.exports = app;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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SCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyxFQUFFO0lBQzdCLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxvREFBb0QsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQ3JHLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUMsQ0FBQztBQUM1QyxDQUFDLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDIiwiZmlsZSI6InNlcnZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBNb2R1bGUgZGVwZW5kZW5jaWVzLlxyXG4gKi9cclxuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcclxuaW1wb3J0ICogYXMgY29tcHJlc3Npb24gZnJvbSAnY29tcHJlc3Npb24nOyAgLy8gY29tcHJlc3NlcyByZXF1ZXN0c1xyXG5pbXBvcnQgKiBhcyBzZXNzaW9uIGZyb20gJ2V4cHJlc3Mtc2Vzc2lvbic7XHJcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSAnYm9keS1wYXJzZXInO1xyXG5pbXBvcnQgKiBhcyBsb2dnZXIgZnJvbSAnbW9yZ2FuJztcclxuaW1wb3J0ICogYXMgZXJyb3JIYW5kbGVyIGZyb20gJ2Vycm9yaGFuZGxlcic7XHJcbmltcG9ydCAqIGFzIGx1c2NhIGZyb20gJ2x1c2NhJztcclxuaW1wb3J0ICogYXMgZG90ZW52IGZyb20gJ2RvdGVudic7XHJcbmltcG9ydCAqIGFzIG1vbmdvIGZyb20gJ2Nvbm5lY3QtbW9uZ28nO1xyXG5pbXBvcnQgKiBhcyBmbGFzaCBmcm9tICdleHByZXNzLWZsYXNoJztcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0ICogYXMgbW9uZ29vc2UgZnJvbSAnbW9uZ29vc2UnO1xyXG5pbXBvcnQgKiBhcyBwYXNzcG9ydCBmcm9tICdwYXNzcG9ydCc7XHJcbmltcG9ydCAqIGFzIHNvY2tldGlvIGZyb20gJ3NvY2tldC5pbyc7XHJcbmltcG9ydCAqIGFzIGh0dHAgZnJvbSAnaHR0cCc7XHJcbmltcG9ydCAqIGFzIHR3aWxpbyBmcm9tICd0d2lsaW8nO1xyXG5pbXBvcnQgdHdpbGlvQ29uZmlnIGZyb20gJy4vY29uZmlnL3R3aWxpbyc7XHJcblxyXG5pbXBvcnQgZXhwcmVzc1ZhbGlkYXRvciA9IHJlcXVpcmUoJ2V4cHJlc3MtdmFsaWRhdG9yJyk7XHJcbnJlcXVpcmUoJy4vY29tbW9uL0FycmF5RXh0ZW5zaW9ucycpO1xyXG5yZXF1aXJlKCcuL2NvbW1vbi9TdHJpbmdFeHRlbnNpb25zJyk7XHJcblxyXG5cclxuY29uc3QgTW9uZ29TdG9yZSA9IG1vbmdvKHNlc3Npb24pO1xyXG5cclxuLyoqXHJcbiAqIExvYWQgZW52aXJvbm1lbnQgdmFyaWFibGVzIGZyb20gLmVudiBmaWxlLCB3aGVyZSBBUEkga2V5cyBhbmQgcGFzc3dvcmRzIGFyZSBjb25maWd1cmVkLlxyXG4gKi9cclxuZG90ZW52LmNvbmZpZyh7IHBhdGg6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuZW52JykgfSk7XHJcblxyXG5cclxuLyoqXHJcbiAqIENvbnRyb2xsZXJzIChyb3V0ZSBoYW5kbGVycykuXHJcbiAqL1xyXG5pbXBvcnQgKiBhcyBob21lQ29udHJvbGxlciBmcm9tICcuL2NvbnRyb2xsZXJzL2hvbWUnO1xyXG5pbXBvcnQgKiBhcyB1c2VyQ29udHJvbGxlciBmcm9tICcuL2NvbnRyb2xsZXJzL3VzZXInO1xyXG5pbXBvcnQgKiBhcyBjb250YWN0Q29udHJvbGxlciBmcm9tICcuL2NvbnRyb2xsZXJzL2NvbnRhY3QnO1xyXG5pbXBvcnQgKiBhcyByZWdpc3RyYXRpb25Db250cm9sbGVyIGZyb20gJy4vY29udHJvbGxlcnMvcmVnaXN0ZXInO1xyXG5pbXBvcnQgKiBhcyBldmVudENvbnRyb2xsZXIgZnJvbSAnLi9jb250cm9sbGVycy9ldmVudCc7XHJcbmltcG9ydCAqIGFzIHJlc3VsdHNDb250cm9sbGVyIGZyb20gJy4vY29udHJvbGxlcnMvcmVzdWx0cyc7XHJcblxyXG4vKipcclxuICogQVBJIGtleXMgYW5kIFBhc3Nwb3J0IGNvbmZpZ3VyYXRpb24uXHJcbiAqL1xyXG5pbXBvcnQgKiBhcyBwYXNzcG9ydENvbmZpZyBmcm9tICcuL2NvbmZpZy9wYXNzcG9ydCc7XHJcblxyXG4vKipcclxuICogQ3JlYXRlIEV4cHJlc3Mgc2VydmVyLlxyXG4gKi9cclxuY29uc3QgYXBwID0gZXhwcmVzcygpO1xyXG5cclxuY29uc3QgaHR0cFNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKGFwcCk7XHJcbmNvbnN0IGlvID0gc29ja2V0aW8oaHR0cFNlcnZlcik7XHJcblxyXG5pby5vbignY29ubmVjdGlvbicsIChzb2NrZXQ6IFNvY2tldElPLlNvY2tldCkgPT4ge1xyXG4gICAgY29uc29sZS5sb2coJ2EgdXNlciBjb25uZWN0ZWQnKTtcclxufSk7XHJcblxyXG4vKipcclxuICogQ29ubmVjdCB0byBNb25nb0RCLlxyXG4gKi9cclxuLy8gbW9uZ29vc2UuUHJvbWlzZSA9IGdsb2JhbC5Qcm9taXNlO1xyXG5tb25nb29zZS5jb25uZWN0KHByb2Nlc3MuZW52Lk1PTkdPREJfVVJJIHx8IHByb2Nlc3MuZW52Lk1PTkdPTEFCX1VSSSk7XHJcblxyXG5tb25nb29zZS5jb25uZWN0aW9uLm9uKCdlcnJvcicsICgpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdNb25nb0RCIGNvbm5lY3Rpb24gZXJyb3IuIFBsZWFzZSBtYWtlIHN1cmUgTW9uZ29EQiBpcyBydW5uaW5nLicpO1xyXG4gICAgcHJvY2Vzcy5leGl0KCk7XHJcbn0pO1xyXG5cclxuKDxhbnk+bW9uZ29vc2UuUHJvbWlzZSkgPSBnbG9iYWwuUHJvbWlzZTtcclxuXHJcblxyXG5cclxuLyoqXHJcbiAqIEV4cHJlc3MgY29uZmlndXJhdGlvbi5cclxuICovXHJcbmFwcC5zZXQoJ3BvcnQnLCBwcm9jZXNzLmVudi5QT1JUIHx8IDMwMDApO1xyXG5hcHAuc2V0KCd2aWV3cycsIHBhdGguam9pbihfX2Rpcm5hbWUsICcuL3ZpZXdzJykpO1xyXG5hcHAuc2V0KCd2aWV3IGVuZ2luZScsICdwdWcnKTtcclxuYXBwLnVzZShjb21wcmVzc2lvbigpKTtcclxuYXBwLnVzZShsb2dnZXIoJ2RldicpKTtcclxuYXBwLnVzZShib2R5UGFyc2VyLmpzb24oKSk7XHJcbmFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IHRydWUgfSkpO1xyXG5hcHAudXNlKGV4cHJlc3NWYWxpZGF0b3IoKSk7XHJcbmFwcC51c2Uoc2Vzc2lvbih7XHJcbiAgICByZXNhdmU6IHRydWUsXHJcbiAgICBzYXZlVW5pbml0aWFsaXplZDogdHJ1ZSxcclxuICAgIHNlY3JldDogcHJvY2Vzcy5lbnYuU0VTU0lPTl9TRUNSRVQsXHJcbiAgICBzdG9yZTogbmV3IE1vbmdvU3RvcmUoe1xyXG4gICAgICAgIHVybDogcHJvY2Vzcy5lbnYuTU9OR09EQl9VUkkgfHwgcHJvY2Vzcy5lbnYuTU9OR09MQUJfVVJJLFxyXG4gICAgICAgIGF1dG9SZWNvbm5lY3Q6IHRydWVcclxuICAgIH0pXHJcbn0pKTtcclxuYXBwLnVzZShwYXNzcG9ydC5pbml0aWFsaXplKCkpO1xyXG5hcHAudXNlKHBhc3Nwb3J0LnNlc3Npb24oKSk7XHJcbmFwcC51c2UoZmxhc2goKSk7XHJcbmFwcC51c2UobHVzY2EueGZyYW1lKCdTQU1FT1JJR0lOJykpO1xyXG5hcHAudXNlKGx1c2NhLnhzc1Byb3RlY3Rpb24odHJ1ZSkpO1xyXG5hcHAudXNlKChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgcmVzLmxvY2Fscy51c2VyID0gcmVxLnVzZXI7XHJcbiAgICBuZXh0KCk7XHJcbn0pO1xyXG5hcHAudXNlKChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgLy8gQWZ0ZXIgc3VjY2Vzc2Z1bCBsb2dpbiwgcmVkaXJlY3QgYmFjayB0byB0aGUgaW50ZW5kZWQgcGFnZVxyXG4gICAgaWYgKCFyZXEudXNlciAmJlxyXG4gICAgICAgIHJlcS5wYXRoICE9PSAnL2xvZ2luJyAmJlxyXG4gICAgICAgIHJlcS5wYXRoICE9PSAnL3NpZ251cCcgJiZcclxuICAgICAgICAhcmVxLnBhdGgubWF0Y2goL15cXC9hdXRoLykgJiZcclxuICAgICAgICAhcmVxLnBhdGgubWF0Y2goL1xcLi8pKSB7XHJcbiAgICAgICAgcmVxLnNlc3Npb24ucmV0dXJuVG8gPSByZXEucGF0aDtcclxuICAgIH0gZWxzZSBpZiAocmVxLnVzZXIgJiZcclxuICAgICAgICByZXEucGF0aCA9PSAnL2FjY291bnQnKSB7XHJcbiAgICAgICAgcmVxLnNlc3Npb24ucmV0dXJuVG8gPSByZXEucGF0aDtcclxuICAgIH1cclxuICAgIG5leHQoKTtcclxufSk7XHJcbmFwcC51c2UoZXhwcmVzcy5zdGF0aWMocGF0aC5qb2luKF9fZGlybmFtZSwgJ3B1YmxpYycpLCB7IG1heEFnZTogMzE1NTc2MDAwMDAgfSkpO1xyXG5cclxuaW8ub24oJ2Nvbm5lY3Rpb24nLCAoc29ja2V0KSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZygnYSB1c2VyIGNvbm5lY3RlZCcpO1xyXG59KTtcclxuXHJcbi8qKlxyXG4gKiBCb2lsZXJwbGF0ZSBhcHAgcm91dGVzLlxyXG4gKi9cclxuYXBwLmdldCgnL2xvZ2luJywgdXNlckNvbnRyb2xsZXIuZ2V0TG9naW4pO1xyXG5hcHAucG9zdCgnL2xvZ2luJywgdXNlckNvbnRyb2xsZXIucG9zdExvZ2luKTtcclxuYXBwLmdldCgnL2xvZ291dCcsIHVzZXJDb250cm9sbGVyLmxvZ291dCk7XHJcbmFwcC5nZXQoJy9mb3Jnb3QnLCB1c2VyQ29udHJvbGxlci5nZXRGb3Jnb3QpO1xyXG5hcHAucG9zdCgnL2ZvcmdvdCcsIHVzZXJDb250cm9sbGVyLnBvc3RGb3Jnb3QpO1xyXG5hcHAuZ2V0KCcvcmVzZXQvOnRva2VuJywgdXNlckNvbnRyb2xsZXIuZ2V0UmVzZXQpO1xyXG5hcHAucG9zdCgnL3Jlc2V0Lzp0b2tlbicsIHVzZXJDb250cm9sbGVyLnBvc3RSZXNldCk7XHJcbmFwcC5nZXQoJy9zaWdudXAnLCB1c2VyQ29udHJvbGxlci5nZXRTaWdudXApO1xyXG5hcHAucG9zdCgnL3NpZ251cCcsIHVzZXJDb250cm9sbGVyLnBvc3RTaWdudXApO1xyXG5hcHAuZ2V0KCcvY29udGFjdCcsIGNvbnRhY3RDb250cm9sbGVyLmdldENvbnRhY3QpO1xyXG5hcHAucG9zdCgnL2NvbnRhY3QnLCBjb250YWN0Q29udHJvbGxlci5wb3N0Q29udGFjdCk7XHJcbmFwcC5nZXQoJy9hY2NvdW50JywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCB1c2VyQ29udHJvbGxlci5nZXRBY2NvdW50KTtcclxuYXBwLmdldCgnL2FjY291bnQvdW5saW5rLzpwcm92aWRlcicsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgdXNlckNvbnRyb2xsZXIuZ2V0T2F1dGhVbmxpbmspO1xyXG5hcHAucG9zdCgnL2FjY291bnQvcHJvZmlsZScsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgdXNlckNvbnRyb2xsZXIucG9zdFVwZGF0ZVByb2ZpbGUpO1xyXG5hcHAucG9zdCgnL2FjY291bnQvcGFzc3dvcmQnLCBwYXNzcG9ydENvbmZpZy5pc0F1dGhlbnRpY2F0ZWQsIHVzZXJDb250cm9sbGVyLnBvc3RVcGRhdGVQYXNzd29yZCk7XHJcbmFwcC5wb3N0KCcvYWNjb3VudC9kZWxldGUnLCBwYXNzcG9ydENvbmZpZy5pc0F1dGhlbnRpY2F0ZWQsIHVzZXJDb250cm9sbGVyLnBvc3REZWxldGVBY2NvdW50KTtcclxuXHJcbi8qKlxyXG4gKiBQcmltYXJ5IGFwcCByb3V0ZXMuXHJcbiAqL1xyXG5hcHAuZ2V0KCcvJywgaG9tZUNvbnRyb2xsZXIuaW5kZXgpO1xyXG5hcHAuZ2V0KCcvZXZlbnQvOmV2ZW50SWQvcmVzdWx0cycsIHJlc3VsdHNDb250cm9sbGVyLmluZGV4KTtcclxuYXBwLmdldCgnL2V2ZW50LzpldmVudElkL3JlZ2lzdGVyJywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCByZWdpc3RyYXRpb25Db250cm9sbGVyLmluZGV4KTtcclxuYXBwLmdldCgnL2V2ZW50LzpldmVudElkL2Fubm91bmNlJywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCBldmVudENvbnRyb2xsZXIuZ2V0QW5ub3VuY2UpO1xyXG5hcHAucG9zdCgnL2V2ZW50LzpldmVudElkL2Fubm91bmNlJywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCBldmVudENvbnRyb2xsZXIuYW5ub3VuY2UpO1xyXG5cclxuLyoqXHJcbiAqIEFwaSByb3V0ZXMuXHJcbiAqL1xyXG5hcHAuZ2V0KCcvYXBpL2V2ZW50cycsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgZXZlbnRDb250cm9sbGVyLmdldEV2ZW50cyk7XHJcbmFwcC5nZXQoJy9hcGkvZXZlbnQvOmV2ZW50SWQnLCBldmVudENvbnRyb2xsZXIuZ2V0RXZlbnQpO1xyXG5hcHAucG9zdCgnL2FwaS9ldmVudC8nLCBwYXNzcG9ydENvbmZpZy5pc0F1dGhlbnRpY2F0ZWQsIGV2ZW50Q29udHJvbGxlci5zYXZlRXZlbnQpO1xyXG5hcHAuZGVsZXRlKCcvYXBpL2V2ZW50LzpldmVudElkJywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCBldmVudENvbnRyb2xsZXIuZGVsZXRlRXZlbnQpO1xyXG5hcHAucG9zdCgnL2FwaS9ldmVudC86ZXZlbnRJZC9pbmNyZW1lbnRyb3VuZCcsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgZXZlbnRDb250cm9sbGVyLmluY3JlbWVudFJvdW5kKTtcclxuYXBwLnBvc3QoJy9hcGkvdm90ZS9zbXMnLCBldmVudENvbnRyb2xsZXIudm90ZVNNUyk7XHJcbmFwcC5nZXQoJy9hcGkvZXZlbnQvOmV2ZW50SWQvcmVnaXN0cmF0aW9ucycsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgcmVnaXN0cmF0aW9uQ29udHJvbGxlci5nZXRSZWdpc3RyYXRpb25zKTtcclxuYXBwLnB1dCgnL2FwaS9ldmVudC86ZXZlbnRJZC9yZWdpc3RlcicsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgcmVnaXN0cmF0aW9uQ29udHJvbGxlci5yZWdpc3RlclZvdGVyKTtcclxuXHJcblxyXG5cclxuLyoqXHJcbiAqIEVycm9yIEhhbmRsZXIuIFByb3ZpZGVzIGZ1bGwgc3RhY2sgLSByZW1vdmUgZm9yIHByb2R1Y3Rpb25cclxuICovXHJcbmFwcC51c2UoZXJyb3JIYW5kbGVyKCkpO1xyXG5cclxuLyoqXHJcbiAqIFN0YXJ0IEV4cHJlc3Mgc2VydmVyLlxyXG4gKi9cclxuYXBwLmxpc3RlbihhcHAuZ2V0KCdwb3J0JyksICgpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCgnICBBcHAgaXMgcnVubmluZyBhdCBodHRwOi8vbG9jYWxob3N0OiVkIGluICVzIG1vZGUnKSwgYXBwLmdldCgncG9ydCcpLCBhcHAuZ2V0KCdlbnYnKSk7XHJcbiAgICBjb25zb2xlLmxvZygnICBQcmVzcyBDVFJMLUMgdG8gc3RvcFxcbicpO1xyXG59KTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gYXBwOyJdfQ==

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Module dependencies.
 */
const express = require("express");
const compression = require("compression"); // compresses requests
const session = require("express-session");
const bodyParser = require("body-parser");
const logger = require("morgan");
const errorHandler = require("errorhandler");
const lusca = require("lusca");
const dotenv = require("dotenv");
const mongo = require("connect-mongo");
const flash = require("express-flash");
const path = require("path");
const mongoose = require("mongoose");
const passport = require("passport");
const socketio = require("socket.io");
const http = require("http");
const expressValidator = require("express-validator");
require('./common/ArrayExtensions');
require('./common/StringExtensions');
const MongoStore = mongo(session);
/**
 * Load environment variables from .env file, where API keys and passwords are configured.
 */
dotenv.config({ path: path.join(__dirname, '.env') });
/**
 * Controllers (route handlers).
 */
const homeController = require("./controllers/home");
const userController = require("./controllers/user");
const contactController = require("./controllers/contact");
const registrationController = require("./controllers/register");
const eventController = require("./controllers/event");
const resultsController = require("./controllers/results");
/**
 * API keys and Passport configuration.
 */
const passportConfig = require("./config/passport");
/**
 * Create Express server.
 */
const app = express();
const httpServer = http.createServer(app);
const io = socketio(httpServer);
io.on('connection', (socket) => {
    console.log('a user connected');
});
/**
 * Connect to MongoDB.
 */
// mongoose.Promise = global.Promise;
mongoose.connect(process.env.MONGODB_URI || process.env.MONGOLAB_URI);
mongoose.connection.on('error', () => {
    console.log('MongoDB connection error. Please make sure MongoDB is running.');
    process.exit();
});
/**
 * Express configuration.
 */
app.set('port', process.env.PORT || 3000);
app.set('views', path.join(__dirname, './views'));
app.set('view engine', 'pug');
app.use(compression());
app.use(logger('dev'));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(expressValidator());
app.use(session({
    resave: true,
    saveUninitialized: true,
    secret: process.env.SESSION_SECRET,
    store: new MongoStore({
        url: process.env.MONGODB_URI || process.env.MONGOLAB_URI,
        autoReconnect: true
    })
}));
app.use(passport.initialize());
app.use(passport.session());
app.use(flash());
app.use(lusca.xframe('SAMEORIGIN'));
app.use(lusca.xssProtection(true));
app.use((req, res, next) => {
    res.locals.user = req.user;
    next();
});
app.use((req, res, next) => {
    // After successful login, redirect back to the intended page
    if (!req.user &&
        req.path !== '/login' &&
        req.path !== '/signup' &&
        !req.path.match(/^\/auth/) &&
        !req.path.match(/\./)) {
        req.session.returnTo = req.path;
    }
    else if (req.user &&
        req.path == '/account') {
        req.session.returnTo = req.path;
    }
    next();
});
app.use(express.static(path.join(__dirname, 'public'), { maxAge: 31557600000 }));
io.on('connection', (socket) => {
    console.log('a user connected');
});
/**
 * Boilerplate app routes.
 */
app.get('/login', userController.getLogin);
app.post('/login', userController.postLogin);
app.get('/logout', userController.logout);
app.get('/forgot', userController.getForgot);
app.post('/forgot', userController.postForgot);
app.get('/reset/:token', userController.getReset);
app.post('/reset/:token', userController.postReset);
app.get('/signup', userController.getSignup);
app.post('/signup', userController.postSignup);
app.get('/contact', contactController.getContact);
app.post('/contact', contactController.postContact);
app.get('/account', passportConfig.isAuthenticated, userController.getAccount);
app.get('/account/unlink/:provider', passportConfig.isAuthenticated, userController.getOauthUnlink);
app.post('/account/profile', passportConfig.isAuthenticated, userController.postUpdateProfile);
app.post('/account/password', passportConfig.isAuthenticated, userController.postUpdatePassword);
app.post('/account/delete', passportConfig.isAuthenticated, userController.postDeleteAccount);
/**
 * Primary app routes.
 */
app.get('/', homeController.index);
app.get('/event/:eventId/results', resultsController.index);
app.get('/event/:eventId/register', passportConfig.isAuthenticated, registrationController.index);
/**
 * Api routes.
 */
app.get('/api/events', passportConfig.isAuthenticated, eventController.getEvents);
app.get('/api/event/:eventId', eventController.getEvent);
app.post('/api/event/', passportConfig.isAuthenticated, eventController.saveEvent);
app.delete('/api/event/:eventId', passportConfig.isAuthenticated, eventController.deleteEvent);
app.post('/api/event/:eventId/incrementround', passportConfig.isAuthenticated, eventController.incrementRound);
app.post('/api/vote/sms', eventController.voteSMS);
/**
 * Error Handler. Provides full stack - remove for production
 */
app.use(errorHandler());
/**
 * Start Express server.
 */
app.listen(app.get('port'), () => {
    console.log(('  App is running at http://localhost:%d in %s mode'), app.get('port'), app.get('env'));
    console.log('  Press CTRL-C to stop\n');
});
module.exports = app;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUcsQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLGNBQWMsQ0FBQyxlQUFlLEVBQUUsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2xGLEdBQUcsQ0FBQyxHQUFHLENBQUMscUJBQXFCLEVBQUUsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3pELEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLGNBQWMsQ0FBQyxlQUFlLEVBQUUsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ25GLEdBQUcsQ0FBQyxNQUFNLENBQUMscUJBQXFCLEVBQUUsY0FBYyxDQUFDLGVBQWUsRUFBRSxlQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDL0YsR0FBRyxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsRUFBRSxjQUFjLENBQUMsZUFBZSxFQUFFLGVBQWUsQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUUvRyxHQUFHLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7QUFFbkQ7O0dBRUc7QUFDSCxHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7QUFFeEI7O0dBRUc7QUFDSCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyxFQUFFO0lBQzdCLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxvREFBb0QsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQ3JHLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUMsQ0FBQztBQUM1QyxDQUFDLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDIiwiZmlsZSI6InNlcnZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBNb2R1bGUgZGVwZW5kZW5jaWVzLlxyXG4gKi9cclxuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcclxuaW1wb3J0ICogYXMgY29tcHJlc3Npb24gZnJvbSAnY29tcHJlc3Npb24nOyAgLy8gY29tcHJlc3NlcyByZXF1ZXN0c1xyXG5pbXBvcnQgKiBhcyBzZXNzaW9uIGZyb20gJ2V4cHJlc3Mtc2Vzc2lvbic7XHJcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSAnYm9keS1wYXJzZXInO1xyXG5pbXBvcnQgKiBhcyBsb2dnZXIgZnJvbSAnbW9yZ2FuJztcclxuaW1wb3J0ICogYXMgZXJyb3JIYW5kbGVyIGZyb20gJ2Vycm9yaGFuZGxlcic7XHJcbmltcG9ydCAqIGFzIGx1c2NhIGZyb20gJ2x1c2NhJztcclxuaW1wb3J0ICogYXMgZG90ZW52IGZyb20gJ2RvdGVudic7XHJcbmltcG9ydCAqIGFzIG1vbmdvIGZyb20gJ2Nvbm5lY3QtbW9uZ28nO1xyXG5pbXBvcnQgKiBhcyBmbGFzaCBmcm9tICdleHByZXNzLWZsYXNoJztcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0ICogYXMgbW9uZ29vc2UgZnJvbSAnbW9uZ29vc2UnO1xyXG5pbXBvcnQgKiBhcyBwYXNzcG9ydCBmcm9tICdwYXNzcG9ydCc7XHJcbmltcG9ydCAqIGFzIHNvY2tldGlvIGZyb20gJ3NvY2tldC5pbyc7XHJcbmltcG9ydCAqIGFzIGh0dHAgZnJvbSAnaHR0cCc7XHJcbmltcG9ydCAqIGFzIHR3aWxpbyBmcm9tICd0d2lsaW8nO1xyXG5pbXBvcnQgdHdpbGlvQ29uZmlnIGZyb20gJy4vY29uZmlnL3R3aWxpbyc7XHJcblxyXG5pbXBvcnQgZXhwcmVzc1ZhbGlkYXRvciA9IHJlcXVpcmUoJ2V4cHJlc3MtdmFsaWRhdG9yJyk7XHJcbnJlcXVpcmUoJy4vY29tbW9uL0FycmF5RXh0ZW5zaW9ucycpO1xyXG5yZXF1aXJlKCcuL2NvbW1vbi9TdHJpbmdFeHRlbnNpb25zJyk7XHJcblxyXG5cclxuY29uc3QgTW9uZ29TdG9yZSA9IG1vbmdvKHNlc3Npb24pO1xyXG5cclxuLyoqXHJcbiAqIExvYWQgZW52aXJvbm1lbnQgdmFyaWFibGVzIGZyb20gLmVudiBmaWxlLCB3aGVyZSBBUEkga2V5cyBhbmQgcGFzc3dvcmRzIGFyZSBjb25maWd1cmVkLlxyXG4gKi9cclxuZG90ZW52LmNvbmZpZyh7IHBhdGg6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuZW52JykgfSk7XHJcblxyXG5cclxuLyoqXHJcbiAqIENvbnRyb2xsZXJzIChyb3V0ZSBoYW5kbGVycykuXHJcbiAqL1xyXG5pbXBvcnQgKiBhcyBob21lQ29udHJvbGxlciBmcm9tICcuL2NvbnRyb2xsZXJzL2hvbWUnO1xyXG5pbXBvcnQgKiBhcyB1c2VyQ29udHJvbGxlciBmcm9tICcuL2NvbnRyb2xsZXJzL3VzZXInO1xyXG5pbXBvcnQgKiBhcyBjb250YWN0Q29udHJvbGxlciBmcm9tICcuL2NvbnRyb2xsZXJzL2NvbnRhY3QnO1xyXG5pbXBvcnQgKiBhcyByZWdpc3RyYXRpb25Db250cm9sbGVyIGZyb20gJy4vY29udHJvbGxlcnMvcmVnaXN0ZXInO1xyXG5pbXBvcnQgKiBhcyBldmVudENvbnRyb2xsZXIgZnJvbSAnLi9jb250cm9sbGVycy9ldmVudCc7XHJcbmltcG9ydCAqIGFzIHJlc3VsdHNDb250cm9sbGVyIGZyb20gJy4vY29udHJvbGxlcnMvcmVzdWx0cyc7XHJcblxyXG4vKipcclxuICogQVBJIGtleXMgYW5kIFBhc3Nwb3J0IGNvbmZpZ3VyYXRpb24uXHJcbiAqL1xyXG5pbXBvcnQgKiBhcyBwYXNzcG9ydENvbmZpZyBmcm9tICcuL2NvbmZpZy9wYXNzcG9ydCc7XHJcblxyXG4vKipcclxuICogQ3JlYXRlIEV4cHJlc3Mgc2VydmVyLlxyXG4gKi9cclxuY29uc3QgYXBwID0gZXhwcmVzcygpO1xyXG5cclxuY29uc3QgaHR0cFNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKGFwcCk7XHJcbmNvbnN0IGlvID0gc29ja2V0aW8oaHR0cFNlcnZlcik7XHJcblxyXG5pby5vbignY29ubmVjdGlvbicsIChzb2NrZXQ6IFNvY2tldElPLlNvY2tldCkgPT4ge1xyXG4gICAgY29uc29sZS5sb2coJ2EgdXNlciBjb25uZWN0ZWQnKTtcclxufSk7XHJcblxyXG4vKipcclxuICogQ29ubmVjdCB0byBNb25nb0RCLlxyXG4gKi9cclxuLy8gbW9uZ29vc2UuUHJvbWlzZSA9IGdsb2JhbC5Qcm9taXNlO1xyXG5tb25nb29zZS5jb25uZWN0KHByb2Nlc3MuZW52Lk1PTkdPREJfVVJJIHx8IHByb2Nlc3MuZW52Lk1PTkdPTEFCX1VSSSk7XHJcblxyXG5tb25nb29zZS5jb25uZWN0aW9uLm9uKCdlcnJvcicsICgpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdNb25nb0RCIGNvbm5lY3Rpb24gZXJyb3IuIFBsZWFzZSBtYWtlIHN1cmUgTW9uZ29EQiBpcyBydW5uaW5nLicpO1xyXG4gICAgcHJvY2Vzcy5leGl0KCk7XHJcbn0pO1xyXG5cclxuXHJcblxyXG4vKipcclxuICogRXhwcmVzcyBjb25maWd1cmF0aW9uLlxyXG4gKi9cclxuYXBwLnNldCgncG9ydCcsIHByb2Nlc3MuZW52LlBPUlQgfHwgMzAwMCk7XHJcbmFwcC5zZXQoJ3ZpZXdzJywgcGF0aC5qb2luKF9fZGlybmFtZSwgJy4vdmlld3MnKSk7XHJcbmFwcC5zZXQoJ3ZpZXcgZW5naW5lJywgJ3B1ZycpO1xyXG5hcHAudXNlKGNvbXByZXNzaW9uKCkpO1xyXG5hcHAudXNlKGxvZ2dlcignZGV2JykpO1xyXG5hcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKTtcclxuYXBwLnVzZShib2R5UGFyc2VyLnVybGVuY29kZWQoeyBleHRlbmRlZDogdHJ1ZSB9KSk7XHJcbmFwcC51c2UoZXhwcmVzc1ZhbGlkYXRvcigpKTtcclxuYXBwLnVzZShzZXNzaW9uKHtcclxuICAgIHJlc2F2ZTogdHJ1ZSxcclxuICAgIHNhdmVVbmluaXRpYWxpemVkOiB0cnVlLFxyXG4gICAgc2VjcmV0OiBwcm9jZXNzLmVudi5TRVNTSU9OX1NFQ1JFVCxcclxuICAgIHN0b3JlOiBuZXcgTW9uZ29TdG9yZSh7XHJcbiAgICAgICAgdXJsOiBwcm9jZXNzLmVudi5NT05HT0RCX1VSSSB8fCBwcm9jZXNzLmVudi5NT05HT0xBQl9VUkksXHJcbiAgICAgICAgYXV0b1JlY29ubmVjdDogdHJ1ZVxyXG4gICAgfSlcclxufSkpO1xyXG5hcHAudXNlKHBhc3Nwb3J0LmluaXRpYWxpemUoKSk7XHJcbmFwcC51c2UocGFzc3BvcnQuc2Vzc2lvbigpKTtcclxuYXBwLnVzZShmbGFzaCgpKTtcclxuYXBwLnVzZShsdXNjYS54ZnJhbWUoJ1NBTUVPUklHSU4nKSk7XHJcbmFwcC51c2UobHVzY2EueHNzUHJvdGVjdGlvbih0cnVlKSk7XHJcbmFwcC51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICByZXMubG9jYWxzLnVzZXIgPSByZXEudXNlcjtcclxuICAgIG5leHQoKTtcclxufSk7XHJcbmFwcC51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICAvLyBBZnRlciBzdWNjZXNzZnVsIGxvZ2luLCByZWRpcmVjdCBiYWNrIHRvIHRoZSBpbnRlbmRlZCBwYWdlXHJcbiAgICBpZiAoIXJlcS51c2VyICYmXHJcbiAgICAgICAgcmVxLnBhdGggIT09ICcvbG9naW4nICYmXHJcbiAgICAgICAgcmVxLnBhdGggIT09ICcvc2lnbnVwJyAmJlxyXG4gICAgICAgICFyZXEucGF0aC5tYXRjaCgvXlxcL2F1dGgvKSAmJlxyXG4gICAgICAgICFyZXEucGF0aC5tYXRjaCgvXFwuLykpIHtcclxuICAgICAgICByZXEuc2Vzc2lvbi5yZXR1cm5UbyA9IHJlcS5wYXRoO1xyXG4gICAgfSBlbHNlIGlmIChyZXEudXNlciAmJlxyXG4gICAgICAgIHJlcS5wYXRoID09ICcvYWNjb3VudCcpIHtcclxuICAgICAgICByZXEuc2Vzc2lvbi5yZXR1cm5UbyA9IHJlcS5wYXRoO1xyXG4gICAgfVxyXG4gICAgbmV4dCgpO1xyXG59KTtcclxuYXBwLnVzZShleHByZXNzLnN0YXRpYyhwYXRoLmpvaW4oX19kaXJuYW1lLCAncHVibGljJyksIHsgbWF4QWdlOiAzMTU1NzYwMDAwMCB9KSk7XHJcblxyXG5pby5vbignY29ubmVjdGlvbicsIChzb2NrZXQpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdhIHVzZXIgY29ubmVjdGVkJyk7XHJcbn0pO1xyXG5cclxuLyoqXHJcbiAqIEJvaWxlcnBsYXRlIGFwcCByb3V0ZXMuXHJcbiAqL1xyXG5hcHAuZ2V0KCcvbG9naW4nLCB1c2VyQ29udHJvbGxlci5nZXRMb2dpbik7XHJcbmFwcC5wb3N0KCcvbG9naW4nLCB1c2VyQ29udHJvbGxlci5wb3N0TG9naW4pO1xyXG5hcHAuZ2V0KCcvbG9nb3V0JywgdXNlckNvbnRyb2xsZXIubG9nb3V0KTtcclxuYXBwLmdldCgnL2ZvcmdvdCcsIHVzZXJDb250cm9sbGVyLmdldEZvcmdvdCk7XHJcbmFwcC5wb3N0KCcvZm9yZ290JywgdXNlckNvbnRyb2xsZXIucG9zdEZvcmdvdCk7XHJcbmFwcC5nZXQoJy9yZXNldC86dG9rZW4nLCB1c2VyQ29udHJvbGxlci5nZXRSZXNldCk7XHJcbmFwcC5wb3N0KCcvcmVzZXQvOnRva2VuJywgdXNlckNvbnRyb2xsZXIucG9zdFJlc2V0KTtcclxuYXBwLmdldCgnL3NpZ251cCcsIHVzZXJDb250cm9sbGVyLmdldFNpZ251cCk7XHJcbmFwcC5wb3N0KCcvc2lnbnVwJywgdXNlckNvbnRyb2xsZXIucG9zdFNpZ251cCk7XHJcbmFwcC5nZXQoJy9jb250YWN0JywgY29udGFjdENvbnRyb2xsZXIuZ2V0Q29udGFjdCk7XHJcbmFwcC5wb3N0KCcvY29udGFjdCcsIGNvbnRhY3RDb250cm9sbGVyLnBvc3RDb250YWN0KTtcclxuYXBwLmdldCgnL2FjY291bnQnLCBwYXNzcG9ydENvbmZpZy5pc0F1dGhlbnRpY2F0ZWQsIHVzZXJDb250cm9sbGVyLmdldEFjY291bnQpO1xyXG5hcHAuZ2V0KCcvYWNjb3VudC91bmxpbmsvOnByb3ZpZGVyJywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCB1c2VyQ29udHJvbGxlci5nZXRPYXV0aFVubGluayk7XHJcbmFwcC5wb3N0KCcvYWNjb3VudC9wcm9maWxlJywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCB1c2VyQ29udHJvbGxlci5wb3N0VXBkYXRlUHJvZmlsZSk7XHJcbmFwcC5wb3N0KCcvYWNjb3VudC9wYXNzd29yZCcsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgdXNlckNvbnRyb2xsZXIucG9zdFVwZGF0ZVBhc3N3b3JkKTtcclxuYXBwLnBvc3QoJy9hY2NvdW50L2RlbGV0ZScsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgdXNlckNvbnRyb2xsZXIucG9zdERlbGV0ZUFjY291bnQpO1xyXG5cclxuLyoqXHJcbiAqIFByaW1hcnkgYXBwIHJvdXRlcy5cclxuICovXHJcbmFwcC5nZXQoJy8nLCBob21lQ29udHJvbGxlci5pbmRleCk7XHJcbmFwcC5nZXQoJy9ldmVudC86ZXZlbnRJZC9yZXN1bHRzJywgcmVzdWx0c0NvbnRyb2xsZXIuaW5kZXgpO1xyXG5hcHAuZ2V0KCcvZXZlbnQvOmV2ZW50SWQvcmVnaXN0ZXInLCBwYXNzcG9ydENvbmZpZy5pc0F1dGhlbnRpY2F0ZWQsIHJlZ2lzdHJhdGlvbkNvbnRyb2xsZXIuaW5kZXgpO1xyXG5cclxuLyoqXHJcbiAqIEFwaSByb3V0ZXMuXHJcbiAqL1xyXG5hcHAuZ2V0KCcvYXBpL2V2ZW50cycsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgZXZlbnRDb250cm9sbGVyLmdldEV2ZW50cyk7XHJcbmFwcC5nZXQoJy9hcGkvZXZlbnQvOmV2ZW50SWQnLCBldmVudENvbnRyb2xsZXIuZ2V0RXZlbnQpO1xyXG5hcHAucG9zdCgnL2FwaS9ldmVudC8nLCBwYXNzcG9ydENvbmZpZy5pc0F1dGhlbnRpY2F0ZWQsIGV2ZW50Q29udHJvbGxlci5zYXZlRXZlbnQpO1xyXG5hcHAuZGVsZXRlKCcvYXBpL2V2ZW50LzpldmVudElkJywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCBldmVudENvbnRyb2xsZXIuZGVsZXRlRXZlbnQpO1xyXG5hcHAucG9zdCgnL2FwaS9ldmVudC86ZXZlbnRJZC9pbmNyZW1lbnRyb3VuZCcsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgZXZlbnRDb250cm9sbGVyLmluY3JlbWVudFJvdW5kKTtcclxuXHJcbmFwcC5wb3N0KCcvYXBpL3ZvdGUvc21zJywgZXZlbnRDb250cm9sbGVyLnZvdGVTTVMpO1xyXG5cclxuLyoqXHJcbiAqIEVycm9yIEhhbmRsZXIuIFByb3ZpZGVzIGZ1bGwgc3RhY2sgLSByZW1vdmUgZm9yIHByb2R1Y3Rpb25cclxuICovXHJcbmFwcC51c2UoZXJyb3JIYW5kbGVyKCkpO1xyXG5cclxuLyoqXHJcbiAqIFN0YXJ0IEV4cHJlc3Mgc2VydmVyLlxyXG4gKi9cclxuYXBwLmxpc3RlbihhcHAuZ2V0KCdwb3J0JyksICgpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCgnICBBcHAgaXMgcnVubmluZyBhdCBodHRwOi8vbG9jYWxob3N0OiVkIGluICVzIG1vZGUnKSwgYXBwLmdldCgncG9ydCcpLCBhcHAuZ2V0KCdlbnYnKSk7XHJcbiAgICBjb25zb2xlLmxvZygnICBQcmVzcyBDVFJMLUMgdG8gc3RvcFxcbicpO1xyXG59KTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gYXBwOyJdfQ==

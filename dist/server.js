"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Module dependencies.
 */
const express = require("express");
const compression = require("compression"); // compresses requests
const session = require("express-session");
const bodyParser = require("body-parser");
const logger = require("morgan");
const errorHandler = require("errorhandler");
const lusca = require("lusca");
const dotenv = require("dotenv");
const mongo = require("connect-mongo");
const flash = require("express-flash");
const path = require("path");
const mongoose = require("mongoose");
const passport = require("passport");
const socketio = require("socket.io");
const http = require("http");
const expressValidator = require("express-validator");
require('./common/ArrayExtensions');
require('./common/StringExtensions');
const MongoStore = mongo(session);
/**
 * Load environment variables from .env file, where API keys and passwords are configured.
 */
dotenv.config({ path: path.join(__dirname, '.env') });
/**
 * Controllers (route handlers).
 */
const homeController = require("./controllers/home");
const userController = require("./controllers/user");
const contactController = require("./controllers/contact");
const registrationController = require("./controllers/register");
const eventController = require("./controllers/event");
const resultsController = require("./controllers/results");
/**
 * API keys and Passport configuration.
 */
const passportConfig = require("./config/passport");
/**
 * Create Express server.
 */
const app = express();
const httpServer = http.createServer(app);
const io = socketio(httpServer);
io.on('connection', (socket) => {
    console.log('a user connected');
});
/**
 * Connect to MongoDB.
 */
// mongoose.Promise = global.Promise;
mongoose.connect(process.env.MONGODB_URI || process.env.MONGOLAB_URI);
mongoose.connection.on('error', () => {
    console.log('MongoDB connection error. Please make sure MongoDB is running.');
    process.exit();
});
/**
 * Express configuration.
 */
app.set('port', process.env.PORT || 3000);
app.set('views', path.join(__dirname, './views'));
app.set('view engine', 'pug');
app.use(compression());
app.use(logger('dev'));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(expressValidator());
app.use(session({
    resave: true,
    saveUninitialized: true,
    secret: process.env.SESSION_SECRET,
    store: new MongoStore({
        url: process.env.MONGODB_URI || process.env.MONGOLAB_URI,
        autoReconnect: true
    })
}));
app.use(passport.initialize());
app.use(passport.session());
app.use(flash());
app.use(lusca.xframe('SAMEORIGIN'));
app.use(lusca.xssProtection(true));
app.use((req, res, next) => {
    res.locals.user = req.user;
    next();
});
app.use((req, res, next) => {
    // After successful login, redirect back to the intended page
    if (!req.user &&
        req.path !== '/login' &&
        req.path !== '/signup' &&
        !req.path.match(/^\/auth/) &&
        !req.path.match(/\./)) {
        req.session.returnTo = req.path;
    }
    else if (req.user &&
        req.path == '/account') {
        req.session.returnTo = req.path;
    }
    next();
});
app.use(express.static(path.join(__dirname, 'public'), { maxAge: 31557600000 }));
io.on('connection', (socket) => {
    console.log('a user connected');
});
/**
 * Boilerplate app routes.
 */
app.get('/login', userController.getLogin);
app.post('/login', userController.postLogin);
app.get('/logout', userController.logout);
app.get('/forgot', userController.getForgot);
app.post('/forgot', userController.postForgot);
app.get('/reset/:token', userController.getReset);
app.post('/reset/:token', userController.postReset);
app.get('/signup', userController.getSignup);
app.post('/signup', userController.postSignup);
app.get('/contact', contactController.getContact);
app.post('/contact', contactController.postContact);
app.get('/account', passportConfig.isAuthenticated, userController.getAccount);
app.get('/account/unlink/:provider', passportConfig.isAuthenticated, userController.getOauthUnlink);
app.post('/account/profile', passportConfig.isAuthenticated, userController.postUpdateProfile);
app.post('/account/password', passportConfig.isAuthenticated, userController.postUpdatePassword);
app.post('/account/delete', passportConfig.isAuthenticated, userController.postDeleteAccount);
/**
 * Primary app routes.
 */
app.get('/', homeController.index);
app.get('/event/:eventId/results', resultsController.index);
app.get('/event/:eventId/register', passportConfig.isAuthenticated, registrationController.index);
app.get('/event/:eventId/announce', passportConfig.isAuthenticated, eventController.getAnnounce);
app.post('/event/:eventId/announce', passportConfig.isAuthenticated, eventController.announce);
/**
 * Api routes.
 */
app.get('/api/events', passportConfig.isAuthenticated, eventController.getEvents);
app.get('/api/event/:eventId', eventController.getEvent);
app.post('/api/event/', passportConfig.isAuthenticated, eventController.saveEvent);
app.delete('/api/event/:eventId', passportConfig.isAuthenticated, eventController.deleteEvent);
app.post('/api/event/:eventId/incrementround', passportConfig.isAuthenticated, eventController.incrementRound);
app.post('/api/vote/sms', eventController.voteSMS);
/**
 * Error Handler. Provides full stack - remove for production
 */
app.use(errorHandler());
/**
 * Start Express server.
 */
app.listen(app.get('port'), () => {
    console.log(('  App is running at http://localhost:%d in %s mode'), app.get('port'), app.get('env'));
    console.log('  Press CTRL-C to stop\n');
});
module.exports = app;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUEwQixDQUFDLENBQUM7QUFDNUMsQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyIsImZpbGUiOiJzZXJ2ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogTW9kdWxlIGRlcGVuZGVuY2llcy5cclxuICovXHJcbmltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCAqIGFzIGNvbXByZXNzaW9uIGZyb20gJ2NvbXByZXNzaW9uJzsgIC8vIGNvbXByZXNzZXMgcmVxdWVzdHNcclxuaW1wb3J0ICogYXMgc2Vzc2lvbiBmcm9tICdleHByZXNzLXNlc3Npb24nO1xyXG5pbXBvcnQgKiBhcyBib2R5UGFyc2VyIGZyb20gJ2JvZHktcGFyc2VyJztcclxuaW1wb3J0ICogYXMgbG9nZ2VyIGZyb20gJ21vcmdhbic7XHJcbmltcG9ydCAqIGFzIGVycm9ySGFuZGxlciBmcm9tICdlcnJvcmhhbmRsZXInO1xyXG5pbXBvcnQgKiBhcyBsdXNjYSBmcm9tICdsdXNjYSc7XHJcbmltcG9ydCAqIGFzIGRvdGVudiBmcm9tICdkb3RlbnYnO1xyXG5pbXBvcnQgKiBhcyBtb25nbyBmcm9tICdjb25uZWN0LW1vbmdvJztcclxuaW1wb3J0ICogYXMgZmxhc2ggZnJvbSAnZXhwcmVzcy1mbGFzaCc7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCAqIGFzIG1vbmdvb3NlIGZyb20gJ21vbmdvb3NlJztcclxuaW1wb3J0ICogYXMgcGFzc3BvcnQgZnJvbSAncGFzc3BvcnQnO1xyXG5pbXBvcnQgKiBhcyBzb2NrZXRpbyBmcm9tICdzb2NrZXQuaW8nO1xyXG5pbXBvcnQgKiBhcyBodHRwIGZyb20gJ2h0dHAnO1xyXG5pbXBvcnQgKiBhcyB0d2lsaW8gZnJvbSAndHdpbGlvJztcclxuaW1wb3J0IHR3aWxpb0NvbmZpZyBmcm9tICcuL2NvbmZpZy90d2lsaW8nO1xyXG5cclxuaW1wb3J0IGV4cHJlc3NWYWxpZGF0b3IgPSByZXF1aXJlKCdleHByZXNzLXZhbGlkYXRvcicpO1xyXG5yZXF1aXJlKCcuL2NvbW1vbi9BcnJheUV4dGVuc2lvbnMnKTtcclxucmVxdWlyZSgnLi9jb21tb24vU3RyaW5nRXh0ZW5zaW9ucycpO1xyXG5cclxuXHJcbmNvbnN0IE1vbmdvU3RvcmUgPSBtb25nbyhzZXNzaW9uKTtcclxuXHJcbi8qKlxyXG4gKiBMb2FkIGVudmlyb25tZW50IHZhcmlhYmxlcyBmcm9tIC5lbnYgZmlsZSwgd2hlcmUgQVBJIGtleXMgYW5kIHBhc3N3b3JkcyBhcmUgY29uZmlndXJlZC5cclxuICovXHJcbmRvdGVudi5jb25maWcoeyBwYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLmVudicpIH0pO1xyXG5cclxuXHJcbi8qKlxyXG4gKiBDb250cm9sbGVycyAocm91dGUgaGFuZGxlcnMpLlxyXG4gKi9cclxuaW1wb3J0ICogYXMgaG9tZUNvbnRyb2xsZXIgZnJvbSAnLi9jb250cm9sbGVycy9ob21lJztcclxuaW1wb3J0ICogYXMgdXNlckNvbnRyb2xsZXIgZnJvbSAnLi9jb250cm9sbGVycy91c2VyJztcclxuaW1wb3J0ICogYXMgY29udGFjdENvbnRyb2xsZXIgZnJvbSAnLi9jb250cm9sbGVycy9jb250YWN0JztcclxuaW1wb3J0ICogYXMgcmVnaXN0cmF0aW9uQ29udHJvbGxlciBmcm9tICcuL2NvbnRyb2xsZXJzL3JlZ2lzdGVyJztcclxuaW1wb3J0ICogYXMgZXZlbnRDb250cm9sbGVyIGZyb20gJy4vY29udHJvbGxlcnMvZXZlbnQnO1xyXG5pbXBvcnQgKiBhcyByZXN1bHRzQ29udHJvbGxlciBmcm9tICcuL2NvbnRyb2xsZXJzL3Jlc3VsdHMnO1xyXG5cclxuLyoqXHJcbiAqIEFQSSBrZXlzIGFuZCBQYXNzcG9ydCBjb25maWd1cmF0aW9uLlxyXG4gKi9cclxuaW1wb3J0ICogYXMgcGFzc3BvcnRDb25maWcgZnJvbSAnLi9jb25maWcvcGFzc3BvcnQnO1xyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSBFeHByZXNzIHNlcnZlci5cclxuICovXHJcbmNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcclxuXHJcbmNvbnN0IGh0dHBTZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApO1xyXG5jb25zdCBpbyA9IHNvY2tldGlvKGh0dHBTZXJ2ZXIpO1xyXG5cclxuaW8ub24oJ2Nvbm5lY3Rpb24nLCAoc29ja2V0OiBTb2NrZXRJTy5Tb2NrZXQpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdhIHVzZXIgY29ubmVjdGVkJyk7XHJcbn0pO1xyXG5cclxuLyoqXHJcbiAqIENvbm5lY3QgdG8gTW9uZ29EQi5cclxuICovXHJcbi8vIG1vbmdvb3NlLlByb21pc2UgPSBnbG9iYWwuUHJvbWlzZTtcclxubW9uZ29vc2UuY29ubmVjdChwcm9jZXNzLmVudi5NT05HT0RCX1VSSSB8fCBwcm9jZXNzLmVudi5NT05HT0xBQl9VUkkpO1xyXG5cclxubW9uZ29vc2UuY29ubmVjdGlvbi5vbignZXJyb3InLCAoKSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZygnTW9uZ29EQiBjb25uZWN0aW9uIGVycm9yLiBQbGVhc2UgbWFrZSBzdXJlIE1vbmdvREIgaXMgcnVubmluZy4nKTtcclxuICAgIHByb2Nlc3MuZXhpdCgpO1xyXG59KTtcclxuXHJcblxyXG5cclxuLyoqXHJcbiAqIEV4cHJlc3MgY29uZmlndXJhdGlvbi5cclxuICovXHJcbmFwcC5zZXQoJ3BvcnQnLCBwcm9jZXNzLmVudi5QT1JUIHx8IDMwMDApO1xyXG5hcHAuc2V0KCd2aWV3cycsIHBhdGguam9pbihfX2Rpcm5hbWUsICcuL3ZpZXdzJykpO1xyXG5hcHAuc2V0KCd2aWV3IGVuZ2luZScsICdwdWcnKTtcclxuYXBwLnVzZShjb21wcmVzc2lvbigpKTtcclxuYXBwLnVzZShsb2dnZXIoJ2RldicpKTtcclxuYXBwLnVzZShib2R5UGFyc2VyLmpzb24oKSk7XHJcbmFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IHRydWUgfSkpO1xyXG5hcHAudXNlKGV4cHJlc3NWYWxpZGF0b3IoKSk7XHJcbmFwcC51c2Uoc2Vzc2lvbih7XHJcbiAgICByZXNhdmU6IHRydWUsXHJcbiAgICBzYXZlVW5pbml0aWFsaXplZDogdHJ1ZSxcclxuICAgIHNlY3JldDogcHJvY2Vzcy5lbnYuU0VTU0lPTl9TRUNSRVQsXHJcbiAgICBzdG9yZTogbmV3IE1vbmdvU3RvcmUoe1xyXG4gICAgICAgIHVybDogcHJvY2Vzcy5lbnYuTU9OR09EQl9VUkkgfHwgcHJvY2Vzcy5lbnYuTU9OR09MQUJfVVJJLFxyXG4gICAgICAgIGF1dG9SZWNvbm5lY3Q6IHRydWVcclxuICAgIH0pXHJcbn0pKTtcclxuYXBwLnVzZShwYXNzcG9ydC5pbml0aWFsaXplKCkpO1xyXG5hcHAudXNlKHBhc3Nwb3J0LnNlc3Npb24oKSk7XHJcbmFwcC51c2UoZmxhc2goKSk7XHJcbmFwcC51c2UobHVzY2EueGZyYW1lKCdTQU1FT1JJR0lOJykpO1xyXG5hcHAudXNlKGx1c2NhLnhzc1Byb3RlY3Rpb24odHJ1ZSkpO1xyXG5hcHAudXNlKChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgcmVzLmxvY2Fscy51c2VyID0gcmVxLnVzZXI7XHJcbiAgICBuZXh0KCk7XHJcbn0pO1xyXG5hcHAudXNlKChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgLy8gQWZ0ZXIgc3VjY2Vzc2Z1bCBsb2dpbiwgcmVkaXJlY3QgYmFjayB0byB0aGUgaW50ZW5kZWQgcGFnZVxyXG4gICAgaWYgKCFyZXEudXNlciAmJlxyXG4gICAgICAgIHJlcS5wYXRoICE9PSAnL2xvZ2luJyAmJlxyXG4gICAgICAgIHJlcS5wYXRoICE9PSAnL3NpZ251cCcgJiZcclxuICAgICAgICAhcmVxLnBhdGgubWF0Y2goL15cXC9hdXRoLykgJiZcclxuICAgICAgICAhcmVxLnBhdGgubWF0Y2goL1xcLi8pKSB7XHJcbiAgICAgICAgcmVxLnNlc3Npb24ucmV0dXJuVG8gPSByZXEucGF0aDtcclxuICAgIH0gZWxzZSBpZiAocmVxLnVzZXIgJiZcclxuICAgICAgICByZXEucGF0aCA9PSAnL2FjY291bnQnKSB7XHJcbiAgICAgICAgcmVxLnNlc3Npb24ucmV0dXJuVG8gPSByZXEucGF0aDtcclxuICAgIH1cclxuICAgIG5leHQoKTtcclxufSk7XHJcbmFwcC51c2UoZXhwcmVzcy5zdGF0aWMocGF0aC5qb2luKF9fZGlybmFtZSwgJ3B1YmxpYycpLCB7IG1heEFnZTogMzE1NTc2MDAwMDAgfSkpO1xyXG5cclxuaW8ub24oJ2Nvbm5lY3Rpb24nLCAoc29ja2V0KSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZygnYSB1c2VyIGNvbm5lY3RlZCcpO1xyXG59KTtcclxuXHJcbi8qKlxyXG4gKiBCb2lsZXJwbGF0ZSBhcHAgcm91dGVzLlxyXG4gKi9cclxuYXBwLmdldCgnL2xvZ2luJywgdXNlckNvbnRyb2xsZXIuZ2V0TG9naW4pO1xyXG5hcHAucG9zdCgnL2xvZ2luJywgdXNlckNvbnRyb2xsZXIucG9zdExvZ2luKTtcclxuYXBwLmdldCgnL2xvZ291dCcsIHVzZXJDb250cm9sbGVyLmxvZ291dCk7XHJcbmFwcC5nZXQoJy9mb3Jnb3QnLCB1c2VyQ29udHJvbGxlci5nZXRGb3Jnb3QpO1xyXG5hcHAucG9zdCgnL2ZvcmdvdCcsIHVzZXJDb250cm9sbGVyLnBvc3RGb3Jnb3QpO1xyXG5hcHAuZ2V0KCcvcmVzZXQvOnRva2VuJywgdXNlckNvbnRyb2xsZXIuZ2V0UmVzZXQpO1xyXG5hcHAucG9zdCgnL3Jlc2V0Lzp0b2tlbicsIHVzZXJDb250cm9sbGVyLnBvc3RSZXNldCk7XHJcbmFwcC5nZXQoJy9zaWdudXAnLCB1c2VyQ29udHJvbGxlci5nZXRTaWdudXApO1xyXG5hcHAucG9zdCgnL3NpZ251cCcsIHVzZXJDb250cm9sbGVyLnBvc3RTaWdudXApO1xyXG5hcHAuZ2V0KCcvY29udGFjdCcsIGNvbnRhY3RDb250cm9sbGVyLmdldENvbnRhY3QpO1xyXG5hcHAucG9zdCgnL2NvbnRhY3QnLCBjb250YWN0Q29udHJvbGxlci5wb3N0Q29udGFjdCk7XHJcbmFwcC5nZXQoJy9hY2NvdW50JywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCB1c2VyQ29udHJvbGxlci5nZXRBY2NvdW50KTtcclxuYXBwLmdldCgnL2FjY291bnQvdW5saW5rLzpwcm92aWRlcicsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgdXNlckNvbnRyb2xsZXIuZ2V0T2F1dGhVbmxpbmspO1xyXG5hcHAucG9zdCgnL2FjY291bnQvcHJvZmlsZScsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgdXNlckNvbnRyb2xsZXIucG9zdFVwZGF0ZVByb2ZpbGUpO1xyXG5hcHAucG9zdCgnL2FjY291bnQvcGFzc3dvcmQnLCBwYXNzcG9ydENvbmZpZy5pc0F1dGhlbnRpY2F0ZWQsIHVzZXJDb250cm9sbGVyLnBvc3RVcGRhdGVQYXNzd29yZCk7XHJcbmFwcC5wb3N0KCcvYWNjb3VudC9kZWxldGUnLCBwYXNzcG9ydENvbmZpZy5pc0F1dGhlbnRpY2F0ZWQsIHVzZXJDb250cm9sbGVyLnBvc3REZWxldGVBY2NvdW50KTtcclxuXHJcbi8qKlxyXG4gKiBQcmltYXJ5IGFwcCByb3V0ZXMuXHJcbiAqL1xyXG5hcHAuZ2V0KCcvJywgaG9tZUNvbnRyb2xsZXIuaW5kZXgpO1xyXG5hcHAuZ2V0KCcvZXZlbnQvOmV2ZW50SWQvcmVzdWx0cycsIHJlc3VsdHNDb250cm9sbGVyLmluZGV4KTtcclxuYXBwLmdldCgnL2V2ZW50LzpldmVudElkL3JlZ2lzdGVyJywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCByZWdpc3RyYXRpb25Db250cm9sbGVyLmluZGV4KTtcclxuYXBwLmdldCgnL2V2ZW50LzpldmVudElkL2Fubm91bmNlJywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCBldmVudENvbnRyb2xsZXIuZ2V0QW5ub3VuY2UpO1xyXG5hcHAucG9zdCgnL2V2ZW50LzpldmVudElkL2Fubm91bmNlJywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCBldmVudENvbnRyb2xsZXIuYW5ub3VuY2UpO1xyXG5cclxuLyoqXHJcbiAqIEFwaSByb3V0ZXMuXHJcbiAqL1xyXG5hcHAuZ2V0KCcvYXBpL2V2ZW50cycsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgZXZlbnRDb250cm9sbGVyLmdldEV2ZW50cyk7XHJcbmFwcC5nZXQoJy9hcGkvZXZlbnQvOmV2ZW50SWQnLCBldmVudENvbnRyb2xsZXIuZ2V0RXZlbnQpO1xyXG5hcHAucG9zdCgnL2FwaS9ldmVudC8nLCBwYXNzcG9ydENvbmZpZy5pc0F1dGhlbnRpY2F0ZWQsIGV2ZW50Q29udHJvbGxlci5zYXZlRXZlbnQpO1xyXG5hcHAuZGVsZXRlKCcvYXBpL2V2ZW50LzpldmVudElkJywgcGFzc3BvcnRDb25maWcuaXNBdXRoZW50aWNhdGVkLCBldmVudENvbnRyb2xsZXIuZGVsZXRlRXZlbnQpO1xyXG5hcHAucG9zdCgnL2FwaS9ldmVudC86ZXZlbnRJZC9pbmNyZW1lbnRyb3VuZCcsIHBhc3Nwb3J0Q29uZmlnLmlzQXV0aGVudGljYXRlZCwgZXZlbnRDb250cm9sbGVyLmluY3JlbWVudFJvdW5kKTtcclxuXHJcbmFwcC5wb3N0KCcvYXBpL3ZvdGUvc21zJywgZXZlbnRDb250cm9sbGVyLnZvdGVTTVMpO1xyXG5cclxuXHJcbi8qKlxyXG4gKiBFcnJvciBIYW5kbGVyLiBQcm92aWRlcyBmdWxsIHN0YWNrIC0gcmVtb3ZlIGZvciBwcm9kdWN0aW9uXHJcbiAqL1xyXG5hcHAudXNlKGVycm9ySGFuZGxlcigpKTtcclxuXHJcbi8qKlxyXG4gKiBTdGFydCBFeHByZXNzIHNlcnZlci5cclxuICovXHJcbmFwcC5saXN0ZW4oYXBwLmdldCgncG9ydCcpLCAoKSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZygoJyAgQXBwIGlzIHJ1bm5pbmcgYXQgaHR0cDovL2xvY2FsaG9zdDolZCBpbiAlcyBtb2RlJyksIGFwcC5nZXQoJ3BvcnQnKSwgYXBwLmdldCgnZW52JykpO1xyXG4gICAgY29uc29sZS5sb2coJyAgUHJlc3MgQ1RSTC1DIHRvIHN0b3BcXG4nKTtcclxufSk7XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IGFwcDsiXX0=

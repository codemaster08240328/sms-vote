"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const Event_1 = require("../models/Event");
const utils = require("../utils");
const Twilio = require("twilio");
const utils_1 = require("../utils");
exports.getAnnounce = (req, res) => __awaiter(this, void 0, void 0, function* () {
    const event = yield Event_1.default.findById(req.params.eventId);
    res.render('announce', {
        title: 'Announcement',
        EventName: event.Name,
        EventId: event._id
    });
});
exports.announce = (req, res, next) => __awaiter(this, void 0, void 0, function* () {
    console.log(`announce() called at ${new Date().toISOString()}`);
    const message = req.param('Message').trim();
    try {
        const event = yield Event_1.default.findById(req.params.eventId);
        const twilioClient = Twilio();
        event.Registrations.forEach(registrant => {
            console.log(`Sending message: ${message} From: ${event.PhoneNumber} To: ${registrant.FirstName} ${registrant.LastName} - ${registrant.PhoneNumber}`);
            twilioClient.messages.create({
                from: event.PhoneNumber,
                to: registrant.PhoneNumber,
                body: message
            });
        });
        req.flash('success', { msg: 'Success! Message sent to all participants!' });
        res.redirect('/');
    }
    catch (err) {
        console.log(err);
        return next(err);
    }
});
exports.voteSMS = (req, res, next) => __awaiter(this, void 0, void 0, function* () {
    res.header('Content-Type', 'text/xml');
    console.log(`voteSMS() called at ${new Date().toISOString()}`);
    const body = req.param('Body').trim();
    // the number the vote it being sent to (this should match an Event)
    const to = req.param('To').slice(1);
    // the voter, use this to keep people from voting more than once
    const from = req.param('From');
    console.log(`Vote received - Body: ${body} From: ${from} To: ${to}`);
    let events;
    try {
        events = yield Event_1.default
            .find({ PhoneNumber: to })
            .limit(1)
            .exec();
    }
    catch (err) {
        console.log(err);
        res.send('<Response>Sorry! Our system encountered an error. Please try again.</Response>');
        return next(err);
    }
    const event = events[0];
    if (events.length < 1) {
        console.log(`No event is configured at this number: ${to}`);
        // silently fail for the user
        res.send('<Response><Sms>Sorry! No event is currently running at this number. Please check the number and try again.</Sms></Response>');
    }
    else if (!event.Enabled) {
        res.send('<Response><Sms>Voting is now closed.</Sms></Response>');
    }
    else if (!utils.testint(body)) {
        console.log('Bad vote: ' + event.Name + ', ' + from + ', ' + body);
        res.send('<Response><Sms>Sorry, invalid vote. Please text a number between 1 and ' + event.Contestants.length + '</Sms></Response>');
    }
    else if (!event.CurrentRound) {
        console.log(`No round is currently selected for event: ${event.Name}`);
        res.send('<Response><Sms>Voting is now closed.</Sms></Response>');
    }
    else if (utils.testint(body) && (parseInt(body) <= 0 || !event.CurrentRound.Contestants.map(c => c.ContestantNumber).contains(parseInt(body)))) {
        console.log('Bad vote: ' + event.Name + ', ' + from + ', ' + body + ', ' + ('[1-' + event.Contestants.length + ']'));
        res.send('<Response><Sms>Sorry, invalid vote. Please text a number between 1 and ' + event.CurrentRound.Contestants.length + '</Sms></Response>');
    }
    else if (event.hasVoted(from)) {
        console.log('Denying vote: ' + event.Name + ', ' + from + ' - Already voted');
        res.send('<Response><Sms>Sorry, you are only allowed to vote once per round.</Sms></Response>');
    }
    else {
        const choice = parseInt(body);
        const registration = event.Registrations.find(r => r.PhoneNumber == from);
        const votedFor = event.CurrentRound.Contestants
            .find(c => c.ContestantNumber === choice);
        votedFor.Votes.push(registration);
        event.save((err) => {
            if (err) {
                res.send('<Response><Sms>We encountered an error saving your vote. Try again?</Sms></Response>');
            }
            else {
                console.log('Accepting vote: ' + votedFor.Name + ', ' + from);
                res.send('<Response><Sms>Thanks for your vote for ' + votedFor.Name + '. Powered by Twilio.</Sms></Response>');
            }
        });
    }
});
exports.saveEvent = (req, res, next) => __awaiter(this, void 0, void 0, function* () {
    const dto = req.body;
    console.log(`Saving event: ${dto.Name}`);
    let savedEvent;
    try {
        if (!dto.PhoneNumber) {
            const error = 'Invalid event record. No PhoneNumber provided.';
            console.error(error);
            throw error;
        }
        if (!utils_1.IsPhoneNumber(dto.PhoneNumber)) {
            const error = `Invalid event record. Phone Number in the wrong format ${dto.PhoneNumber}.`;
            console.error(error);
            throw error;
        }
        if (!dto._id) {
            const eventDTO = dto;
            eventDTO.Rounds = eventDTO.Rounds.map(r => {
                r.IsFinished = false;
                return r;
            });
            const event = new Event_1.default(eventDTO);
            savedEvent = yield event.save();
            const result = {
                Success: true,
                Data: savedEvent
            };
            res.json(result);
        }
        else {
            savedEvent = yield Event_1.default.findByIdAndUpdate(dto._id, dto, { upsert: true });
            const result = {
                Success: true,
                Data: savedEvent
            };
            res.json(result);
        }
    }
    catch (err) {
        return next(err);
    }
});
exports.deleteEvent = (req, res, next) => {
    Event_1.default.findByIdAndRemove(req.params.eventId, (err, product) => {
        if (err) {
            return next(err);
        }
        const result = {
            Success: true
        };
        res.json(result);
    });
};
exports.getEvents = (req, res, next) => {
    Event_1.default.find((err, events) => {
        if (err) {
            return next(err);
        }
        events = events.map(v => {
            v.Contestants = v.Contestants.sort((c1, c2) => c1.ContestantNumber - c2.ContestantNumber);
            return v;
        });
        res.json(events);
    });
};
exports.getEvent = (req, res, next) => __awaiter(this, void 0, void 0, function* () {
    let event;
    try {
        event = yield Event_1.default.findById(req.params.eventId);
    }
    catch (err) {
        return next(err);
    }
    event.Contestants = event.Contestants.sort((c1, c2) => c1.ContestantNumber - c2.ContestantNumber);
    res.json(event);
});
exports.incrementRound = (req, res, next) => __awaiter(this, void 0, void 0, function* () {
    let event;
    try {
        event = yield Event_1.default.findById(req.params.eventId);
        if (event.CurrentRound) { // if a round is running, complete it
            console.log(`Closing round ${event.CurrentRound.RoundNumber}`);
            const currentRound = event.Rounds
                .find(r => r.RoundNumber == event.CurrentRound.RoundNumber);
            currentRound.IsFinished = true;
            currentRound.Contestants = event.CurrentRound.Contestants;
            event.CurrentRound = null;
            const result = yield event.save();
            const operationResult = {
                Success: true,
                Data: result
            };
            res.json(operationResult);
        }
        else {
            const availableRounds = event.Rounds.filter(r => !r.IsFinished);
            if (availableRounds.length > 0) { // if there are any rounds left, start the next one
                const nextRound = availableRounds.reduce((prev, cur) => {
                    return prev.RoundNumber < cur.RoundNumber ? prev : cur;
                });
                console.log(`Starting round ${nextRound.RoundNumber}`);
                event.CurrentRound = nextRound;
                const result = yield event.save();
                const operationResult = {
                    Success: true,
                    Data: result
                };
                res.json(operationResult);
            }
            else { // can't increment because all rounds are finished. return failure.
                console.log('Attempted to increment round on finished event.');
                const operationResult = {
                    Success: false
                };
                res.json(operationResult);
            }
        }
    }
    catch (err) {
        return next(err);
    }
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QU8sRUFBRSxLQUFLO2lCQUNqQixDQUFDO2dCQUNGLEdBQUcsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7YUFDN0I7U0FDSjtLQUNKO0lBQ0QsT0FBTyxHQUFHLEVBQUU7UUFDUixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUNwQjtBQUNMLENBQUMsQ0FBQSxDQUFDIiwiZmlsZSI6ImNvbnRyb2xsZXJzL2V2ZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgeyBkZWZhdWx0IGFzIEV2ZW50TW9kZWwsIEV2ZW50RG9jdW1lbnQgfSBmcm9tICcuLi9tb2RlbHMvRXZlbnQnO1xyXG5pbXBvcnQgeyBSb3VuZENvbmZpZ0RUTyB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC9Sb3VuZERUTyc7XHJcbmltcG9ydCB7IFJvdW5kQ29udGVzdGFudERUTywgRXZlbnRDb250ZXN0YW50RFRPIH0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL0NvbnRlc3RhbnREVE8nO1xyXG5pbXBvcnQgeyBFdmVudENvbmZpZ0RUTywgRXZlbnREVE8gfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvRXZlbnREVE8nO1xyXG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tICcuLi91dGlscyc7XHJcbmltcG9ydCB7IERhdGFPcGVyYXRpb25SZXN1bHQsIE9wZXJhdGlvblJlc3VsdCwgQ3JlYXRlT3BlcmF0aW9uUmVzdWx0IH0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL09wZXJhdGlvblJlc3VsdCc7XHJcbmltcG9ydCB7IG5leHRUaWNrIH0gZnJvbSAncS9pbmRleCc7XHJcbmltcG9ydCAqIGFzIFR3aWxpbyBmcm9tICd0d2lsaW8nO1xyXG5pbXBvcnQgeyBJc1Bob25lTnVtYmVyIH0gZnJvbSAnLi4vdXRpbHMnO1xyXG5cclxuZXhwb3J0IGxldCBnZXRBbm5vdW5jZSA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgIGNvbnN0IGV2ZW50ID0gYXdhaXQgRXZlbnRNb2RlbC5maW5kQnlJZChyZXEucGFyYW1zLmV2ZW50SWQpO1xyXG4gICAgcmVzLnJlbmRlcignYW5ub3VuY2UnLCB7XHJcbiAgICAgICAgdGl0bGU6ICdBbm5vdW5jZW1lbnQnLFxyXG4gICAgICAgIEV2ZW50TmFtZTogZXZlbnQuTmFtZSxcclxuICAgICAgICBFdmVudElkOiBldmVudC5faWRcclxuICAgIH0pO1xyXG4gIH07XHJcblxyXG5leHBvcnQgY29uc3QgYW5ub3VuY2UgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcclxuICAgIGNvbnNvbGUubG9nKGBhbm5vdW5jZSgpIGNhbGxlZCBhdCAke25ldyBEYXRlKCkudG9JU09TdHJpbmcoKX1gKTtcclxuXHJcbiAgICBjb25zdCBtZXNzYWdlID0gcmVxLnBhcmFtKCdNZXNzYWdlJykudHJpbSgpO1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBldmVudCA9IGF3YWl0IEV2ZW50TW9kZWwuZmluZEJ5SWQocmVxLnBhcmFtcy5ldmVudElkKTtcclxuXHJcbiAgICAgICAgY29uc3QgdHdpbGlvQ2xpZW50ID0gVHdpbGlvKCk7XHJcblxyXG4gICAgICAgIGV2ZW50LlJlZ2lzdHJhdGlvbnMuZm9yRWFjaChyZWdpc3RyYW50ID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coYFNlbmRpbmcgbWVzc2FnZTogJHttZXNzYWdlfSBGcm9tOiAke2V2ZW50LlBob25lTnVtYmVyfSBUbzogJHtyZWdpc3RyYW50LkZpcnN0TmFtZX0gJHtyZWdpc3RyYW50Lkxhc3ROYW1lfSAtICR7cmVnaXN0cmFudC5QaG9uZU51bWJlcn1gKTtcclxuICAgICAgICAgICAgdHdpbGlvQ2xpZW50Lm1lc3NhZ2VzLmNyZWF0ZSh7XHJcbiAgICAgICAgICAgICAgICBmcm9tOiBldmVudC5QaG9uZU51bWJlcixcclxuICAgICAgICAgICAgICAgIHRvOiByZWdpc3RyYW50LlBob25lTnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgYm9keTogbWVzc2FnZVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVxLmZsYXNoKCdzdWNjZXNzJywgeyBtc2c6ICdTdWNjZXNzISBNZXNzYWdlIHNlbnQgdG8gYWxsIHBhcnRpY2lwYW50cyEnIH0pO1xyXG4gICAgICAgIHJlcy5yZWRpcmVjdCgnLycpO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcclxuICAgICAgICByZXR1cm4gbmV4dChlcnIpO1xyXG4gICAgfVxyXG5cclxufTtcclxuXHJcblxyXG5leHBvcnQgY29uc3Qgdm90ZVNNUyA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xyXG4gICAgcmVzLmhlYWRlcignQ29udGVudC1UeXBlJywgJ3RleHQveG1sJyk7XHJcblxyXG4gICAgY29uc29sZS5sb2coYHZvdGVTTVMoKSBjYWxsZWQgYXQgJHtuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCl9YCk7XHJcblxyXG4gICAgY29uc3QgYm9keSA9IHJlcS5wYXJhbSgnQm9keScpLnRyaW0oKTtcclxuICAgIC8vIHRoZSBudW1iZXIgdGhlIHZvdGUgaXQgYmVpbmcgc2VudCB0byAodGhpcyBzaG91bGQgbWF0Y2ggYW4gRXZlbnQpXHJcbiAgICBjb25zdCB0byA9IHJlcS5wYXJhbSgnVG8nKS5zbGljZSgxKTtcclxuXHJcbiAgICAvLyB0aGUgdm90ZXIsIHVzZSB0aGlzIHRvIGtlZXAgcGVvcGxlIGZyb20gdm90aW5nIG1vcmUgdGhhbiBvbmNlXHJcbiAgICBjb25zdCBmcm9tID0gcmVxLnBhcmFtKCdGcm9tJyk7XHJcbiAgICBjb25zb2xlLmxvZyhgVm90ZSByZWNlaXZlZCAtIEJvZHk6ICR7Ym9keX0gRnJvbTogJHtmcm9tfSBUbzogJHt0b31gKTtcclxuXHJcbiAgICBsZXQgZXZlbnRzOiBFdmVudERvY3VtZW50W107XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGV2ZW50cyA9IGF3YWl0IEV2ZW50TW9kZWxcclxuICAgICAgICAgICAgLmZpbmQoIHsgUGhvbmVOdW1iZXI6IHRvIH0gKVxyXG4gICAgICAgICAgICAubGltaXQoMSlcclxuICAgICAgICAgICAgLmV4ZWMoKTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgcmVzLnNlbmQoJzxSZXNwb25zZT5Tb3JyeSEgT3VyIHN5c3RlbSBlbmNvdW50ZXJlZCBhbiBlcnJvci4gUGxlYXNlIHRyeSBhZ2Fpbi48L1Jlc3BvbnNlPicpO1xyXG4gICAgICAgIHJldHVybiBuZXh0KGVycik7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZXZlbnQgPSBldmVudHNbMF07XHJcblxyXG4gICAgaWYgKGV2ZW50cy5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYE5vIGV2ZW50IGlzIGNvbmZpZ3VyZWQgYXQgdGhpcyBudW1iZXI6ICR7dG99YCk7XHJcbiAgICAgICAgLy8gc2lsZW50bHkgZmFpbCBmb3IgdGhlIHVzZXJcclxuICAgICAgICByZXMuc2VuZCgnPFJlc3BvbnNlPjxTbXM+U29ycnkhIE5vIGV2ZW50IGlzIGN1cnJlbnRseSBydW5uaW5nIGF0IHRoaXMgbnVtYmVyLiBQbGVhc2UgY2hlY2sgdGhlIG51bWJlciBhbmQgdHJ5IGFnYWluLjwvU21zPjwvUmVzcG9uc2U+Jyk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICghZXZlbnQuRW5hYmxlZCkge1xyXG4gICAgICAgIHJlcy5zZW5kKCc8UmVzcG9uc2U+PFNtcz5Wb3RpbmcgaXMgbm93IGNsb3NlZC48L1Ntcz48L1Jlc3BvbnNlPicpO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoIXV0aWxzLnRlc3RpbnQoYm9keSkpIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnQmFkIHZvdGU6ICcgKyBldmVudC5OYW1lICsgJywgJyArIGZyb20gKyAnLCAnICsgYm9keSk7XHJcbiAgICAgICAgcmVzLnNlbmQoJzxSZXNwb25zZT48U21zPlNvcnJ5LCBpbnZhbGlkIHZvdGUuIFBsZWFzZSB0ZXh0IGEgbnVtYmVyIGJldHdlZW4gMSBhbmQgJyArIGV2ZW50LkNvbnRlc3RhbnRzLmxlbmd0aCArICc8L1Ntcz48L1Jlc3BvbnNlPicpO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoIWV2ZW50LkN1cnJlbnRSb3VuZCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBObyByb3VuZCBpcyBjdXJyZW50bHkgc2VsZWN0ZWQgZm9yIGV2ZW50OiAke2V2ZW50Lk5hbWV9YCk7XHJcbiAgICAgICAgcmVzLnNlbmQoJzxSZXNwb25zZT48U21zPlZvdGluZyBpcyBub3cgY2xvc2VkLjwvU21zPjwvUmVzcG9uc2U+Jyk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICh1dGlscy50ZXN0aW50KGJvZHkpICYmIChwYXJzZUludChib2R5KSA8PSAwIHx8ICFldmVudC5DdXJyZW50Um91bmQuQ29udGVzdGFudHMubWFwKGMgPT4gYy5Db250ZXN0YW50TnVtYmVyKS5jb250YWlucyhwYXJzZUludChib2R5KSkpKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ0JhZCB2b3RlOiAnICsgZXZlbnQuTmFtZSArICcsICcgKyBmcm9tICsgJywgJyArIGJvZHkgKyAnLCAnICsgKCdbMS0nICsgZXZlbnQuQ29udGVzdGFudHMubGVuZ3RoICsgJ10nKSk7XHJcbiAgICAgICAgcmVzLnNlbmQoJzxSZXNwb25zZT48U21zPlNvcnJ5LCBpbnZhbGlkIHZvdGUuIFBsZWFzZSB0ZXh0IGEgbnVtYmVyIGJldHdlZW4gMSBhbmQgJyArIGV2ZW50LkN1cnJlbnRSb3VuZC5Db250ZXN0YW50cy5sZW5ndGggKyAnPC9TbXM+PC9SZXNwb25zZT4nKTtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKGV2ZW50Lmhhc1ZvdGVkKGZyb20pKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ0Rlbnlpbmcgdm90ZTogJyArIGV2ZW50Lk5hbWUgKyAnLCAnICsgZnJvbSArICcgLSBBbHJlYWR5IHZvdGVkJyk7XHJcbiAgICAgICAgcmVzLnNlbmQoJzxSZXNwb25zZT48U21zPlNvcnJ5LCB5b3UgYXJlIG9ubHkgYWxsb3dlZCB0byB2b3RlIG9uY2UgcGVyIHJvdW5kLjwvU21zPjwvUmVzcG9uc2U+Jyk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBjb25zdCBjaG9pY2UgPSBwYXJzZUludChib2R5KTtcclxuICAgICAgICBjb25zdCByZWdpc3RyYXRpb24gPSBldmVudC5SZWdpc3RyYXRpb25zLmZpbmQociA9PiByLlBob25lTnVtYmVyID09IGZyb20pO1xyXG5cclxuICAgICAgICBjb25zdCB2b3RlZEZvciA9IGV2ZW50LkN1cnJlbnRSb3VuZC5Db250ZXN0YW50c1xyXG4gICAgICAgICAgICAuZmluZChjID0+IGMuQ29udGVzdGFudE51bWJlciA9PT0gY2hvaWNlKTtcclxuICAgICAgICB2b3RlZEZvci5Wb3Rlcy5wdXNoKHJlZ2lzdHJhdGlvbik7XHJcblxyXG4gICAgICAgIGV2ZW50LnNhdmUoKGVycikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICByZXMuc2VuZCgnPFJlc3BvbnNlPjxTbXM+V2UgZW5jb3VudGVyZWQgYW4gZXJyb3Igc2F2aW5nIHlvdXIgdm90ZS4gVHJ5IGFnYWluPzwvU21zPjwvUmVzcG9uc2U+Jyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQWNjZXB0aW5nIHZvdGU6ICcgKyB2b3RlZEZvci5OYW1lICsgJywgJyArIGZyb20pO1xyXG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoJzxSZXNwb25zZT48U21zPlRoYW5rcyBmb3IgeW91ciB2b3RlIGZvciAnICsgdm90ZWRGb3IuTmFtZSArICcuIFBvd2VyZWQgYnkgVHdpbGlvLjwvU21zPjwvUmVzcG9uc2U+Jyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBzYXZlRXZlbnQgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcclxuICAgIGNvbnN0IGR0bzogRXZlbnRDb25maWdEVE8gPSByZXEuYm9keTtcclxuICAgIGNvbnNvbGUubG9nKGBTYXZpbmcgZXZlbnQ6ICR7ZHRvLk5hbWV9YCk7XHJcbiAgICBsZXQgc2F2ZWRFdmVudDogRXZlbnREb2N1bWVudDtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgaWYgKCFkdG8uUGhvbmVOdW1iZXIpIHtcclxuICAgICAgICAgICAgY29uc3QgZXJyb3IgPSAnSW52YWxpZCBldmVudCByZWNvcmQuIE5vIFBob25lTnVtYmVyIHByb3ZpZGVkLic7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFJc1Bob25lTnVtYmVyKGR0by5QaG9uZU51bWJlcikpIHtcclxuICAgICAgICAgICAgY29uc3QgZXJyb3IgPSBgSW52YWxpZCBldmVudCByZWNvcmQuIFBob25lIE51bWJlciBpbiB0aGUgd3JvbmcgZm9ybWF0ICR7ZHRvLlBob25lTnVtYmVyfS5gO1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcclxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIWR0by5faWQpIHtcclxuICAgICAgICAgICAgY29uc3QgZXZlbnREVE86IEV2ZW50RFRPID0gZHRvIGFzIEV2ZW50RFRPO1xyXG4gICAgICAgICAgICBldmVudERUTy5Sb3VuZHMgPSBldmVudERUTy5Sb3VuZHMubWFwKHIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHIuSXNGaW5pc2hlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICBjb25zdCBldmVudCA9IG5ldyBFdmVudE1vZGVsKGV2ZW50RFRPKTtcclxuICAgICAgICAgICAgICAgIHNhdmVkRXZlbnQgPSBhd2FpdCBldmVudC5zYXZlKCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQ6IERhdGFPcGVyYXRpb25SZXN1bHQ8RXZlbnREVE8+ID0ge1xyXG4gICAgICAgICAgICAgICAgU3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIERhdGE6IHNhdmVkRXZlbnRcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgcmVzLmpzb24ocmVzdWx0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzYXZlZEV2ZW50ID0gYXdhaXQgRXZlbnRNb2RlbC5maW5kQnlJZEFuZFVwZGF0ZShkdG8uX2lkLCBkdG8sIHsgdXBzZXJ0OiB0cnVlIH0pO1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQ6IERhdGFPcGVyYXRpb25SZXN1bHQ8RXZlbnREVE8+ID0ge1xyXG4gICAgICAgICAgICAgICAgU3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIERhdGE6IHNhdmVkRXZlbnRcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgcmVzLmpzb24ocmVzdWx0KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmV0dXJuIG5leHQoZXJyKTtcclxuICAgIH1cclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBkZWxldGVFdmVudCA9IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xyXG4gICAgRXZlbnRNb2RlbC5maW5kQnlJZEFuZFJlbW92ZShyZXEucGFyYW1zLmV2ZW50SWQsIChlcnIsIHByb2R1Y3Q6IEV2ZW50RG9jdW1lbnQpID0+IHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXh0KGVycik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCByZXN1bHQ6IE9wZXJhdGlvblJlc3VsdCA9IHtcclxuICAgICAgICAgICAgU3VjY2VzczogdHJ1ZVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJlcy5qc29uKHJlc3VsdCk7XHJcbiAgICB9KTtcclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBnZXRFdmVudHMgPSAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcclxuICAgIEV2ZW50TW9kZWwuZmluZCgoZXJyLCBldmVudHM6IEV2ZW50RG9jdW1lbnRbXSkgPT4ge1xyXG4gICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5leHQoZXJyKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZXZlbnRzID0gZXZlbnRzLm1hcCh2ID0+IHtcclxuICAgICAgICAgICAgdi5Db250ZXN0YW50cyA9IHYuQ29udGVzdGFudHMuc29ydCgoYzEsIGMyKSA9PiBjMS5Db250ZXN0YW50TnVtYmVyIC0gYzIuQ29udGVzdGFudE51bWJlcik7XHJcbiAgICAgICAgICAgIHJldHVybiB2O1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJlcy5qc29uKGV2ZW50cyk7XHJcbiAgICB9KTtcclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBnZXRFdmVudCA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xyXG4gICAgbGV0IGV2ZW50OiBFdmVudERvY3VtZW50O1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBldmVudCA9IGF3YWl0IEV2ZW50TW9kZWwuZmluZEJ5SWQocmVxLnBhcmFtcy5ldmVudElkKTtcclxuICAgIH1cclxuICAgIGNhdGNoIChlcnIpIHtcclxuICAgICAgICByZXR1cm4gbmV4dChlcnIpO1xyXG4gICAgfVxyXG4gICAgZXZlbnQuQ29udGVzdGFudHMgPSBldmVudC5Db250ZXN0YW50cy5zb3J0KChjMSwgYzIpID0+IGMxLkNvbnRlc3RhbnROdW1iZXIgLSBjMi5Db250ZXN0YW50TnVtYmVyKTtcclxuICAgIHJlcy5qc29uKGV2ZW50KTtcclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBpbmNyZW1lbnRSb3VuZCA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xyXG4gICAgbGV0IGV2ZW50OiBFdmVudERvY3VtZW50O1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBldmVudCA9IGF3YWl0IEV2ZW50TW9kZWwuZmluZEJ5SWQocmVxLnBhcmFtcy5ldmVudElkKTtcclxuXHJcbiAgICAgICAgaWYgKGV2ZW50LkN1cnJlbnRSb3VuZCkgeyAvLyBpZiBhIHJvdW5kIGlzIHJ1bm5pbmcsIGNvbXBsZXRlIGl0XHJcblxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgQ2xvc2luZyByb3VuZCAke2V2ZW50LkN1cnJlbnRSb3VuZC5Sb3VuZE51bWJlcn1gKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRSb3VuZCA9IGV2ZW50LlJvdW5kc1xyXG4gICAgICAgICAgICAgICAgLmZpbmQociA9PiByLlJvdW5kTnVtYmVyID09IGV2ZW50LkN1cnJlbnRSb3VuZC5Sb3VuZE51bWJlcik7XHJcbiAgICAgICAgICAgIGN1cnJlbnRSb3VuZC5Jc0ZpbmlzaGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgY3VycmVudFJvdW5kLkNvbnRlc3RhbnRzID0gZXZlbnQuQ3VycmVudFJvdW5kLkNvbnRlc3RhbnRzO1xyXG4gICAgICAgICAgICBldmVudC5DdXJyZW50Um91bmQgPSBudWxsO1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBldmVudC5zYXZlKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IG9wZXJhdGlvblJlc3VsdDogRGF0YU9wZXJhdGlvblJlc3VsdDxFdmVudERUTz4gPSB7XHJcbiAgICAgICAgICAgICAgICBTdWNjZXNzOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgRGF0YTogcmVzdWx0XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHJlcy5qc29uKG9wZXJhdGlvblJlc3VsdCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBhdmFpbGFibGVSb3VuZHMgPSBldmVudC5Sb3VuZHMuZmlsdGVyKHIgPT4gIXIuSXNGaW5pc2hlZCk7XHJcbiAgICAgICAgICAgIGlmIChhdmFpbGFibGVSb3VuZHMubGVuZ3RoID4gMCkgeyAvLyBpZiB0aGVyZSBhcmUgYW55IHJvdW5kcyBsZWZ0LCBzdGFydCB0aGUgbmV4dCBvbmVcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5leHRSb3VuZCA9IGF2YWlsYWJsZVJvdW5kcy5yZWR1Y2UoKHByZXYsIGN1cikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwcmV2LlJvdW5kTnVtYmVyIDwgY3VyLlJvdW5kTnVtYmVyID8gcHJldiA6IGN1cjtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBTdGFydGluZyByb3VuZCAke25leHRSb3VuZC5Sb3VuZE51bWJlcn1gKTtcclxuXHJcbiAgICAgICAgICAgICAgICBldmVudC5DdXJyZW50Um91bmQgPSBuZXh0Um91bmQ7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBldmVudC5zYXZlKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvcGVyYXRpb25SZXN1bHQ6IERhdGFPcGVyYXRpb25SZXN1bHQ8RXZlbnREVE8+ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIFN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgRGF0YTogcmVzdWx0XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgcmVzLmpzb24ob3BlcmF0aW9uUmVzdWx0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHsgLy8gY2FuJ3QgaW5jcmVtZW50IGJlY2F1c2UgYWxsIHJvdW5kcyBhcmUgZmluaXNoZWQuIHJldHVybiBmYWlsdXJlLlxyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0F0dGVtcHRlZCB0byBpbmNyZW1lbnQgcm91bmQgb24gZmluaXNoZWQgZXZlbnQuJyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvcGVyYXRpb25SZXN1bHQ6IE9wZXJhdGlvblJlc3VsdCA9IHtcclxuICAgICAgICAgICAgICAgICAgICBTdWNjZXNzOiBmYWxzZVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHJlcy5qc29uKG9wZXJhdGlvblJlc3VsdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmV0dXJuIG5leHQoZXJyKTtcclxuICAgIH1cclxufTsiXX0=

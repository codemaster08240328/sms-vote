"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Registration_1 = require("../models/Registration");
const Event_1 = require("../models/Event");
const utils_1 = require("../utils");
const Twilio = require("twilio");
/**
 * GET /
 * Event/{eventId}/Register
 */
exports.index = async (req, res, next) => {
    let event;
    try {
        event = await Event_1.default
            .findById(req.params.eventId)
            .exec();
    }
    catch (err) {
        console.log(err);
        return next(err);
    }
    res.render('register', {
        title: 'Register voters',
        EventName: event.Name
    });
};
/**
 * GET /
 * api/Event/{eventId}/Registrations
 */
exports.getRegistrations = async (req, res, next) => {
    console.log('getRegistrations()...');
    try {
        const event = await Event_1.default.findById(req.params.eventId).populate('Registrations').exec();
        res.json(event.Registrations);
    }
    catch (err) {
        console.log(err);
        return next(err);
    }
};
/**
 * PUT /
 * api/Event/{eventId}/Registration
 */
exports.registerVoter = async (req, res, next) => {
    const dto = req.body;
    console.log(`Registering ${dto.PhoneNumber}`);
    try {
        if (!dto.PhoneNumber) {
            const error = 'Invalid registration record. No PhoneNumber provided.';
            console.error(error);
            throw error;
        }
        if (!utils_1.IsPhoneNumber(dto.PhoneNumber)) {
            const error = `Invalid registration record. Phone Number in the wrong format ${dto.PhoneNumber}.`;
            console.error(error);
            throw error;
        }
        dto.PhoneNumber = utils_1.SanitizePhoneNumber(dto.PhoneNumber);
        let registration = await Registration_1.default.findOne({ PhoneNumber: dto.PhoneNumber });
        if (registration) {
            registration.FirstName = dto.FirstName;
            registration.LastName = dto.LastName;
            registration.Email = dto.Email;
            registration.PhoneNumber = dto.PhoneNumber;
        }
        else {
            registration = new Registration_1.default(dto);
        }
        const savedRegistration = await registration.save();
        const event = await Event_1.default.findById(req.params.eventId);
        const eventRegistration = event.Registrations.find(rid => rid == savedRegistration._id);
        if (!eventRegistration) {
            event.Registrations.push(savedRegistration._id);
        }
        const savedEvent = await event.save();
        const result = {
            Success: true,
            Data: registration
        };
        const twilioClient = Twilio();
        twilioClient.messages.create({
            from: event.PhoneNumber,
            to: dto.PhoneNumber,
            body: event.RegistrationConfirmationMessage
        });
        console.log(`Successfully registered ${dto.FirstName} ${dto.LastName} - ${dto.PhoneNumber}`);
        res.json(result);
    }
    catch (err) {
        return next(err);
    }
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QjtJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ1YsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDcEI7QUFFTCxDQUFDLENBQUMiLCJmaWxlIjoiY29udHJvbGxlcnMvcmVnaXN0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBkZWZhdWx0IGFzIFJlZ2lzdHJhdGlvbk1vZGVsLCBSZWdpc3RyYXRpb25Eb2N1bWVudCB9IGZyb20gJy4uL21vZGVscy9SZWdpc3RyYXRpb24nO1xuaW1wb3J0IFJlZ2lzdHJhdGlvbkRUTyBmcm9tICcuLi8uLi8uLi9zaGFyZWQvUmVnaXN0cmF0aW9uRFRPJztcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IERhdGFPcGVyYXRpb25SZXN1bHQsIE9wZXJhdGlvblJlc3VsdCwgQ3JlYXRlT3BlcmF0aW9uUmVzdWx0IH0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL09wZXJhdGlvblJlc3VsdCc7XG5pbXBvcnQgeyBFdmVudERvY3VtZW50IH0gZnJvbSAnLi4vbW9kZWxzL0V2ZW50JztcbmltcG9ydCBFdmVudE1vZGVsIGZyb20gJy4uL21vZGVscy9FdmVudCc7XG5pbXBvcnQgKiBhcyBtb25nb29zZSBmcm9tICdtb25nb29zZSc7XG5pbXBvcnQgeyBJc1Bob25lTnVtYmVyLCBTYW5pdGl6ZVBob25lTnVtYmVyIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0ICogYXMgVHdpbGlvIGZyb20gJ3R3aWxpbyc7XG5cbi8qKlxuICogR0VUIC9cbiAqIEV2ZW50L3tldmVudElkfS9SZWdpc3RlclxuICovXG5leHBvcnQgY29uc3QgaW5kZXggPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBsZXQgZXZlbnQ6IEV2ZW50RG9jdW1lbnQ7XG4gICAgdHJ5IHtcbiAgICAgICAgZXZlbnQgPSBhd2FpdCBFdmVudE1vZGVsXG4gICAgICAgICAgICAuZmluZEJ5SWQocmVxLnBhcmFtcy5ldmVudElkKVxuICAgICAgICAgICAgLmV4ZWMoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgcmV0dXJuIG5leHQoZXJyKTtcbiAgICB9XG4gICAgcmVzLnJlbmRlcigncmVnaXN0ZXInLCB7XG4gICAgICAgIHRpdGxlOiAnUmVnaXN0ZXIgdm90ZXJzJyxcbiAgICAgICAgRXZlbnROYW1lOiBldmVudC5OYW1lXG4gICAgfSk7XG59O1xuXG4vKipcbiAqIEdFVCAvXG4gKiBhcGkvRXZlbnQve2V2ZW50SWR9L1JlZ2lzdHJhdGlvbnNcbiAqL1xuZXhwb3J0IGNvbnN0IGdldFJlZ2lzdHJhdGlvbnMgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBjb25zb2xlLmxvZygnZ2V0UmVnaXN0cmF0aW9ucygpLi4uJyk7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZXZlbnQgPSBhd2FpdCBFdmVudE1vZGVsLmZpbmRCeUlkKHJlcS5wYXJhbXMuZXZlbnRJZCkucG9wdWxhdGUoJ1JlZ2lzdHJhdGlvbnMnKS5leGVjKCk7XG4gICAgICAgIHJlcy5qc29uKGV2ZW50LlJlZ2lzdHJhdGlvbnMpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICByZXR1cm4gbmV4dChlcnIpO1xuICAgIH1cbn07XG5cbi8qKlxuICogUFVUIC9cbiAqIGFwaS9FdmVudC97ZXZlbnRJZH0vUmVnaXN0cmF0aW9uXG4gKi9cbmV4cG9ydCBjb25zdCByZWdpc3RlclZvdGVyID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgY29uc3QgZHRvOiBSZWdpc3RyYXRpb25EVE8gPSByZXEuYm9keTtcbiAgICBjb25zb2xlLmxvZyhgUmVnaXN0ZXJpbmcgJHtkdG8uUGhvbmVOdW1iZXJ9YCk7XG4gICAgdHJ5IHtcbiAgICAgICAgaWYgKCFkdG8uUGhvbmVOdW1iZXIpIHtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yID0gJ0ludmFsaWQgcmVnaXN0cmF0aW9uIHJlY29yZC4gTm8gUGhvbmVOdW1iZXIgcHJvdmlkZWQuJztcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFJc1Bob25lTnVtYmVyKGR0by5QaG9uZU51bWJlcikpIHtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yID0gYEludmFsaWQgcmVnaXN0cmF0aW9uIHJlY29yZC4gUGhvbmUgTnVtYmVyIGluIHRoZSB3cm9uZyBmb3JtYXQgJHtkdG8uUGhvbmVOdW1iZXJ9LmA7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG5cbiAgICAgICAgZHRvLlBob25lTnVtYmVyID0gU2FuaXRpemVQaG9uZU51bWJlcihkdG8uUGhvbmVOdW1iZXIpO1xuXG4gICAgICAgIGxldCByZWdpc3RyYXRpb24gPSBhd2FpdCBSZWdpc3RyYXRpb25Nb2RlbC5maW5kT25lKHsgUGhvbmVOdW1iZXI6IGR0by5QaG9uZU51bWJlciB9KTtcbiAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbikge1xuICAgICAgICAgICAgcmVnaXN0cmF0aW9uLkZpcnN0TmFtZSA9IGR0by5GaXJzdE5hbWU7XG4gICAgICAgICAgICByZWdpc3RyYXRpb24uTGFzdE5hbWUgPSBkdG8uTGFzdE5hbWU7XG4gICAgICAgICAgICByZWdpc3RyYXRpb24uRW1haWwgPSBkdG8uRW1haWw7XG4gICAgICAgICAgICByZWdpc3RyYXRpb24uUGhvbmVOdW1iZXIgPSBkdG8uUGhvbmVOdW1iZXI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWdpc3RyYXRpb24gPSBuZXcgUmVnaXN0cmF0aW9uTW9kZWwoZHRvKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzYXZlZFJlZ2lzdHJhdGlvbiA9IGF3YWl0IHJlZ2lzdHJhdGlvbi5zYXZlKCk7XG4gICAgICAgIGNvbnN0IGV2ZW50ID0gYXdhaXQgRXZlbnRNb2RlbC5maW5kQnlJZChyZXEucGFyYW1zLmV2ZW50SWQpO1xuICAgICAgICBjb25zdCBldmVudFJlZ2lzdHJhdGlvbiA9IGV2ZW50LlJlZ2lzdHJhdGlvbnMuZmluZChyaWQgPT4gcmlkID09IHNhdmVkUmVnaXN0cmF0aW9uLl9pZCk7XG4gICAgICAgIGlmICghZXZlbnRSZWdpc3RyYXRpb24pIHtcbiAgICAgICAgICAgIGV2ZW50LlJlZ2lzdHJhdGlvbnMucHVzaChzYXZlZFJlZ2lzdHJhdGlvbi5faWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2F2ZWRFdmVudCA9IGF3YWl0IGV2ZW50LnNhdmUoKTtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBEYXRhT3BlcmF0aW9uUmVzdWx0PFJlZ2lzdHJhdGlvbkRUTz4gPSB7XG4gICAgICAgICAgICBTdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgRGF0YTogcmVnaXN0cmF0aW9uXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgdHdpbGlvQ2xpZW50ID0gVHdpbGlvKCk7XG4gICAgICAgIHR3aWxpb0NsaWVudC5tZXNzYWdlcy5jcmVhdGUoe1xuICAgICAgICAgICAgZnJvbTogZXZlbnQuUGhvbmVOdW1iZXIsXG4gICAgICAgICAgICB0bzogZHRvLlBob25lTnVtYmVyLFxuICAgICAgICAgICAgYm9keTogZXZlbnQuUmVnaXN0cmF0aW9uQ29uZmlybWF0aW9uTWVzc2FnZVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zb2xlLmxvZyhgU3VjY2Vzc2Z1bGx5IHJlZ2lzdGVyZWQgJHtkdG8uRmlyc3ROYW1lfSAke2R0by5MYXN0TmFtZX0gLSAke2R0by5QaG9uZU51bWJlcn1gKTtcbiAgICAgICAgcmVzLmpzb24ocmVzdWx0KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmV0dXJuIG5leHQoZXJyKTtcbiAgICB9XG5cbn07Il19
